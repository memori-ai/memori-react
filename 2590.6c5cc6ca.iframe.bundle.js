"use strict";(self.webpackChunk_memori_ai_memori_react=self.webpackChunk_memori_ai_memori_react||[]).push([[2590],{"./src/components/Avatar/AvatarView/index.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>ContainerAvatarView});var react=__webpack_require__("./node_modules/react/index.js"),react_three_fiber_esm=__webpack_require__("./node_modules/@react-three/fiber/dist/react-three-fiber.esm.js"),PerspectiveCamera=__webpack_require__("./node_modules/@react-three/drei/core/PerspectiveCamera.js"),OrbitControls=__webpack_require__("./node_modules/@react-three/drei/core/OrbitControls.js"),three_module=__webpack_require__("./node_modules/three/build/three.module.js"),useGLTF=__webpack_require__("./node_modules/@react-three/drei/core/useGLTF.js"),useAnimations=__webpack_require__("./node_modules/@react-three/drei/core/useAnimations.js");const AVATAR_POSITION=new three_module.Vector3(0,-1,0),AVATAR_ROTATION=new three_module.Euler(.175,0,0),AVATAR_POSITION_ZOOMED=new three_module.Vector3(0,-1.45,0),MAPPING_EMOTIONS_ITALIAN_TO_ENGLISH=[{italian:"Gioia",english:"Joy"},{italian:"Rabbia",english:"Anger"},{italian:"Sorpresa",english:"Surprise"},{italian:"Tristezza",english:"Sadness"},{italian:"Timore",english:"Fear"}],MAPPING_BLEND_SHAPE_TO_EMOTION_RPM=[{emotion:{italian:"Rabbia",english:"Anger"},blendShapes:{browDownLeft:.5,browDownRight:.5,browOuterUpLeft:.5,browOuterUpRight:.5,mouthSmile:-.2}},{emotion:{italian:"Timore",english:"Fear"},blendShapes:{browOuterUpLeft:-.5,browOuterUpRight:-.5,eyeWideLeft:-.5,eyeWideRight:-.5}},{emotion:{italian:"Tristezza",english:"Sadness"},blendShapes:{browDownLeft:-.5,browDownRight:-.5,eyeSquintLeft:.5,eyeSquintRight:.5,mouthSmile:-.6}},{emotion:{italian:"Sorpresa",english:"Surprise"},blendShapes:{browInnerUp:.5,browOuterUpLeft:.5,browOuterUpRight:.5,eyeWideLeft:.5,eyeWideRight:.5,mouthSmile:.5}},{emotion:{italian:"Gioia",english:"Joy"},blendShapes:{browDownLeft:.5,browDownRight:.5,browInnerUp:.5,mouthSmile:.5}}],ANIMATION_URLS={MALE:"https://assets.memori.ai/api/v2/asset/2c5e88a4-cf62-408b-9ef0-518b099dfcb2.glb",FEMALE:"https://assets.memori.ai/api/v2/asset/2adc934b-24b2-45bd-94ad-ffec58d3cb32.glb"},BLINK_CONFIG_minInterval=1e3,BLINK_CONFIG_maxInterval=5e3,BLINK_CONFIG_blinkDuration=150;class MorphTargetController{currentEmotionValues={};previousEmotionKeys=new Set;isRPM=!1;rpmBlendShapes=MAPPING_BLEND_SHAPE_TO_EMOTION_RPM;customGlbMapping=MAPPING_EMOTIONS_ITALIAN_TO_ENGLISH;constructor(headMesh,rpmBlendShapes,customGlbMapping){this.headMesh=headMesh,this.isRPM="GBNL__Head"!==headMesh.name,rpmBlendShapes&&(this.rpmBlendShapes=rpmBlendShapes),customGlbMapping&&(this.customGlbMapping=customGlbMapping)}processChatEmission(chatEmission,isLoading){const defaultEmotions=this.getDefaultEmotionMorphTargets();if(isLoading||!chatEmission)return defaultEmotions;const hasOutputTagEmotion=chatEmission?.includes('<output class="memori-emotion">');if(!hasOutputTagEmotion)return defaultEmotions;const outputContentEmotion=chatEmission?.split('<output class="memori-emotion">')[1]?.split("</output>")[0]?.trim();return outputContentEmotion?this.processEmotion(outputContentEmotion):defaultEmotions}processEmotion(emotionName){const defaultEmotions=this.getDefaultEmotionMorphTargets();if(this.isRPM){const foundEmotion=this.rpmBlendShapes.find(item=>item.emotion.italian.toLowerCase()===emotionName.toLowerCase()||item.emotion.english.toLowerCase()===emotionName.toLowerCase());if(foundEmotion)return{...defaultEmotions,...foundEmotion.blendShapes}}else{const foundEmotion=this.customGlbMapping.find(item=>item.italian.toLowerCase()===emotionName.toLowerCase()||item.english.toLowerCase()===emotionName.toLowerCase());if(foundEmotion)return{...defaultEmotions,[foundEmotion.english]:1}}return defaultEmotions}getDefaultEmotionMorphTargets(){if(this.isRPM){const allBlendShapeKeys=new Set;return this.rpmBlendShapes.forEach(item=>{Object.keys(item.blendShapes).forEach(key=>allBlendShapeKeys.add(key))}),Array.from(allBlendShapeKeys).reduce((acc,key)=>({...acc,[key]:0}),{})}return this.customGlbMapping.reduce((acc,emotion)=>({...acc,[emotion.english]:0}),{})}updateMorphTargets(currentTime,chatEmission,isLoading,currentViseme,eyeBlink,blinkState){if(!this.headMesh.morphTargetDictionary||!this.headMesh.morphTargetInfluences)return void console.error("[MorphTargetController] Missing morphTargetDictionary or morphTargetInfluences");const emotionMorphTargets=this.processChatEmission(chatEmission,isLoading),blinkValue=this.calculateBlinkValue(currentTime,blinkState,eyeBlink),currentEmotionKeys=new Set(Object.keys(emotionMorphTargets));Object.entries(this.headMesh.morphTargetDictionary).forEach(([key,index])=>{if("number"!=typeof index)return;let targetValue=0;if(currentEmotionKeys.has(key)){const targetEmotionValue=emotionMorphTargets[key],currentEmotionValue=this.currentEmotionValues[key]||0,newEmotionValue=three_module.MathUtils.lerp(currentEmotionValue,1.5*targetEmotionValue,.3);this.currentEmotionValues[key]=newEmotionValue,targetValue+=newEmotionValue}if(currentViseme&&key===currentViseme.name&&(targetValue+=currentViseme.weight),"eyesClosed"===key&&eyeBlink&&(targetValue+=blinkValue),targetValue=three_module.MathUtils.clamp(targetValue,0,1),this.headMesh.morphTargetInfluences){const finalValue=three_module.MathUtils.lerp(this.headMesh.morphTargetInfluences[index]||0,targetValue,.5);this.headMesh.morphTargetInfluences[index]=finalValue}}),this.previousEmotionKeys=currentEmotionKeys}calculateBlinkValue(currentTime,blinkState,eyeBlink){if(!eyeBlink)return 0;let blinkValue=0;if(currentTime>=blinkState.nextBlinkTime&&!blinkState.isBlinking&&(blinkState.isBlinking=!0,blinkState.blinkStartTime=currentTime,blinkState.lastBlinkTime=currentTime,blinkState.nextBlinkTime=currentTime+Math.random()*(BLINK_CONFIG_maxInterval-BLINK_CONFIG_minInterval)+BLINK_CONFIG_minInterval),blinkState.isBlinking){const blinkProgress=(currentTime-blinkState.blinkStartTime)/BLINK_CONFIG_blinkDuration;blinkProgress<=.5?blinkValue=2*blinkProgress:blinkProgress<=1?blinkValue=2-2*blinkProgress:(blinkState.isBlinking=!1,blinkValue=0)}return blinkValue}}class AvatarPositionController{constructor(defaultPosition=AVATAR_POSITION.clone(),zoomedPosition=AVATAR_POSITION_ZOOMED.clone(),initialCameraZ=.6){this.defaultPosition=defaultPosition,this.zoomedPosition=zoomedPosition,this.currentScale=new three_module.Vector3(1,1,1),this.targetScale=new three_module.Vector3(1,1,1),this.currentPosition=defaultPosition.clone(),this.basePosition=defaultPosition.clone(),this.initialCameraPosition=new three_module.Vector3(0,0,initialCameraZ)}mapHeightToScale(sliderValue,isHalfBody){return isHalfBody?three_module.MathUtils.lerp(1.4,2.1,sliderValue/100):three_module.MathUtils.lerp(.5,1.5,sliderValue/100)}mapDepthToCamera(depthValue,isHalfBody){const baseZ=this.initialCameraPosition.z;return three_module.MathUtils.lerp(baseZ,baseZ+3,depthValue/100)}updateHeight(heightValue,isHalfBody){const heightScale=this.mapHeightToScale(heightValue,isHalfBody);this.targetScale.set(heightScale,heightScale,heightScale)}updateDepth(depthValue,isHalfBody){return this.mapDepthToCamera(depthValue,isHalfBody)}updateBasePosition(isZoomed){const newPosition=isZoomed?this.zoomedPosition:this.defaultPosition;this.basePosition.copy(newPosition),this.currentPosition.copy(newPosition)}updateScale(lerpFactor){return this.currentScale.lerp(this.targetScale,lerpFactor),this.currentScale}getPosition(){return this.currentPosition}reset(){this.currentScale.set(1,1,1),this.targetScale.set(1,1,1),this.currentPosition.copy(this.defaultPosition),this.basePosition.copy(this.defaultPosition)}}class AvatarAnimator{mixer=null;actions={};animations=new Map;currentAnimation=null;currentSequence=null;sequenceIndex=0;isTransitioning=!1;timeScale=1;fadeInDuration=.8;fadeOutDuration=.8;avatarType="CUSTOM_GLB";eventListeners={start:[],complete:[],loop:[],transition:[],error:[]};initialized=!1;idleRotationCount=0;currentIdleAnimation=null;idleRotationLimit=5;lastAnimationTime=null;async initialize(scene,preloadedActions,animations=[],avatarType="CUSTOM_GLB"){if(this.initialized||this.mixer)return void console.warn("[AvatarAnimator] Already initialized, ignoring duplicate initialization");this.mixer=new three_module.AnimationMixer(scene),this.avatarType=avatarType,this.actions={},this.registerClipsDirectly(animations),Object.entries(preloadedActions).forEach(([name,action])=>{this.actions[name]||(this.actions[name]=action,this.registerAnimation(name,action))}),this.setupMixerEvents();const idleAnimations=["Idle1","Idle2","Idle3","Idle4","Idle5"];let startedSuccessfully=!1;for(const idleName of idleAnimations)if(this.actions[idleName])try{const idleAction=this.actions[idleName];idleAction.reset(),idleAction.setEffectiveTimeScale(1),idleAction.setEffectiveWeight(1),idleAction.setLoop(1/0,1/0),idleAction.play(),this.currentAnimation=idleName,this.currentIdleAnimation=idleName,this.idleRotationCount=0,startedSuccessfully=!0;break}catch(error){console.error(`Error starting ${idleName}:`,error)}startedSuccessfully||console.warn("[AvatarAnimator] Could not start any idle animation directly"),this.initialized=!0}registerClipsDirectly(clips){this.mixer&&clips.forEach(clip=>{const action=this.mixer?.clipAction(clip);action?(this.actions[clip.name]=action,this.registerAnimation(clip.name,action)):console.warn(`[AvatarAnimator] Failed to create action for clip: ${clip.name}`)})}registerAnimation(name,action){const duration=action.getClip().duration;let category="ACTION",defaultLoopCount=1,canLoop=!1;const lowerName=name.toLowerCase();lowerName.includes("idle")?(category="IDLE",defaultLoopCount=0,canLoop=!0):(lowerName.includes("loading")||lowerName.includes("wait"))&&(category="LOADING",defaultLoopCount=0,canLoop=!0),this.animations.set(name,{name,category,duration,canLoop,defaultLoopCount})}play(animationName,options={}){try{if(!this.initialized||!this.mixer)return void console.warn(`[AvatarAnimator] Cannot play ${animationName} - not initialized`);const nextAction=this.actions[animationName];if(!nextAction){if(console.warn(`[AvatarAnimator] Animation not found: ${animationName}`),!1!==options.fallbackToIdle){const fallbackAnim=Object.keys(this.actions)[0];fallbackAnim&&this.play(fallbackAnim,{...options,fallbackToIdle:!1})}return}const animInfo=this.getAnimationInfo(animationName);if(!animInfo)return console.warn(`[AvatarAnimator] Animation info not found: ${animationName}`),void(!1!==options.fallbackToIdle&&this.idle());if(this.currentAnimation===animationName&&!this.isTransitioning&&void 0===options.loopCount)return;if(this.isTransitioning&&this.currentAnimation){const currentAction=this.actions[this.currentAnimation];currentAction&&currentAction.fadeOut(.1)}const fadeIn=options.fadeInDuration??this.fadeInDuration,fadeOut=options.fadeOutDuration??this.fadeOutDuration,loopCount=options.loopCount??animInfo.defaultLoopCount,timeScale=options.timeScale??this.timeScale;if("IDLE"===animInfo.category&&(this.currentIdleAnimation=animationName,this.idleRotationCount=0),this.emit("transition",{from:this.currentAnimation,to:animationName}),this.currentAnimation){const currentAction=this.actions[this.currentAnimation];currentAction&&(this.currentAnimation===animationName?currentAction.stop():currentAction.fadeOut(fadeOut))}nextAction.reset(),nextAction.fadeIn(fadeIn),nextAction.timeScale=timeScale,nextAction.enabled=!0,0===loopCount?nextAction.setLoop(1/0,1/0):(nextAction.setLoop(loopCount>1?loopCount:three_module.LoopOnce,loopCount>1?loopCount:1),nextAction.clampWhenFinished=!0),nextAction.play(),this.currentAnimation=animationName,this.isTransitioning=!0;const transitionDuration=1e3*Math.max(fadeIn,fadeOut);setTimeout(()=>{this.isTransitioning=!1},transitionDuration),this.emit("start",{animation:animationName,category:animInfo.category,loopCount})}catch(error){if(console.error(`[AvatarAnimator] Error in play method for ${animationName}:`,error),!1!==options.fallbackToIdle)try{this.idle()}catch(recoveryError){console.error("[AvatarAnimator] Failed to recover with idle animation:",recoveryError)}}}execute(command){if(this.initialized)try{let loopCount;const loopMatch=command.match(/\[loop=(\d+)\]/);if(loopMatch&&(loopCount=parseInt(loopMatch[1],10),command=command.replace(loopMatch[0],"").trim()),command.includes("->")){const sequence=command.split("->").map(s=>s.trim());this.playSequence(sequence,{loopCount})}else this.play(command,{loopCount})}catch(error){console.error("[AvatarAnimator] Error executing animation command:",error),this.emit("error",{error,command}),this.idle()}else console.warn("[AvatarAnimator] Cannot execute - not initialized")}processChatEmission(chatEmission,isLoading){if(!this.initialized)return void console.warn("[AvatarAnimator] Cannot process chat emission - not initialized");const wasInLoadingState="LOADING"===this.getAnimationCategory();if(isLoading){if(wasInLoadingState)return;return void this.loading()}if(!chatEmission){if("IDLE"===this.getAnimationCategory())return;return void this.idle(wasInLoadingState?{fadeInDuration:1.2,fadeOutDuration:1}:void 0)}const sequenceMatch=chatEmission.match(/<output class="animation-sequence">(.*?)<\/output>/),animationMatch=chatEmission.match(/<output class="animation">(.*?)(\[loop=(\d+)\])?<\/output>/),emotionMatch=chatEmission.match(/<output class="memori-emotion">(.*?)<\/output>/),transitionOptions=this.calculateTransitionOptions();if(sequenceMatch&&sequenceMatch[1]){const sequence=sequenceMatch[1].trim();if(this.currentSequence&&this.currentSequence.join("->")===sequence&&this.sequenceIndex<this.currentSequence.length)return;return void this.executeWithTransition(sequence,transitionOptions)}if(animationMatch&&animationMatch[1]){const animation=animationMatch[1].trim();let loopCount;return animationMatch[3]&&(loopCount=parseInt(animationMatch[3],10)),void this.play(animation,{...transitionOptions,loopCount})}if(emotionMatch&&emotionMatch[1]){const emotion=emotionMatch[1].trim();let matchingAnimations=[];if(MAPPING_EMOTIONS_ITALIAN_TO_ENGLISH.find(item=>item.english===emotion)){let matchingEmotions=MAPPING_EMOTIONS_ITALIAN_TO_ENGLISH.filter(item=>item.english===emotion);matchingAnimations=this.getAllAnimationNames().filter(name=>matchingEmotions.some(emotion=>name.toLowerCase().startsWith(emotion.italian.toLowerCase())))}else matchingAnimations=this.getAllAnimationNames().filter(name=>name.toLowerCase().startsWith(emotion.toLowerCase()));if(matchingAnimations.length>0){const animationToPlay=matchingAnimations[Math.floor(Math.random()*matchingAnimations.length)];return void this.play(animationToPlay,transitionOptions)}console.log("[AvatarAnimator] No matching animations found for emotion:",emotion)}"IDLE"!==this.getAnimationCategory()&&this.idle(transitionOptions)}calculateTransitionOptions(){const options={fadeInDuration:this.fadeInDuration,fadeOutDuration:this.fadeOutDuration,timeScale:this.timeScale},currentAction=(this.getAnimationCategory(),this.currentAnimation?this.actions[this.currentAnimation]:null);if(options.fadeOutDuration=.8,options.fadeInDuration=.8,currentAction){const clip=currentAction.getClip(),progress=currentAction.time/clip.duration;progress>.75?options.fadeOutDuration=Math.max(.4,.8*(options.fadeOutDuration??.8)):progress<.25&&(options.fadeInDuration=Math.max(.4,.8*(options.fadeInDuration??.8)))}return options}executeWithTransition(command,options={}){if(this.initialized)try{let loopCount;const loopMatch=command.match(/\[loop=(\d+)\]/);if(loopMatch&&(loopCount=parseInt(loopMatch[1],10),command=command.replace(loopMatch[0],"").trim()),command.includes("->")){const sequence=command.split("->").map(s=>s.trim()),sequenceOptions={...options,loopCount:loopCount||1};this.playSequence(sequence,sequenceOptions)}else this.play(command,{...options,loopCount})}catch(error){console.error("[AvatarAnimator] Error executing animation command:",error),this.emit("error",{error,command}),this.idle()}else console.warn("[AvatarAnimator] Cannot execute - not initialized")}idle(options={}){const idleAnimations=this.getAnimationsByCategory("IDLE");if(idleAnimations.length>0){let availableIdles=idleAnimations;"IDLE"===this.getAnimationCategory()&&(availableIdles=idleAnimations.filter(info=>info.name!==this.currentAnimation),0===availableIdles.length&&(availableIdles=idleAnimations));const selectedIdle=availableIdles[Math.floor(Math.random()*availableIdles.length)].name,transitionOptions={fadeInDuration:options.fadeInDuration??.7,fadeOutDuration:options.fadeOutDuration??.7,timeScale:options.timeScale??.9,loopCount:0,...options};return transitionOptions.loopCount=0,this.play(selectedIdle,transitionOptions),this.currentIdleAnimation=selectedIdle,void(this.idleRotationCount=0)}{console.warn("[AvatarAnimator] No idle animations available, checking fallback options");const loopableAnimations=Array.from(this.animations.values()).filter(info=>info.canLoop).map(info=>info.name);if(loopableAnimations.length>0){const fallbackAnimation=loopableAnimations[Math.floor(Math.random()*loopableAnimations.length)];this.play(fallbackAnimation,{loopCount:0,fadeInDuration:options.fadeInDuration??.7,fadeOutDuration:options.fadeOutDuration??.7,timeScale:options.timeScale??.9}),this.currentIdleAnimation=fallbackAnimation,this.idleRotationCount=0}else if(Object.keys(this.actions).length>0){const firstAnimation=Object.keys(this.actions)[0];this.play(firstAnimation,{loopCount:0,fadeInDuration:options.fadeInDuration??.7,fadeOutDuration:options.fadeOutDuration??.7,timeScale:options.timeScale??.9}),this.currentIdleAnimation=firstAnimation,this.idleRotationCount=0}}}loading(options={}){const randomLoading=this.getRandomAnimation("LOADING");if(randomLoading){const transitionOptions={loopCount:0,fadeInDuration:options.fadeInDuration??.8,fadeOutDuration:options.fadeOutDuration??.8,timeScale:options.timeScale??this.timeScale,...options};transitionOptions.loopCount=0,this.play(randomLoading,transitionOptions)}else console.warn("[AvatarAnimator] No loading animations available, using idle instead"),this.idle(options)}playSequence(sequence,options={}){if(!sequence||0===sequence.length)return void console.warn("[AvatarAnimator] Empty animation sequence provided");sequence.length>5&&(console.warn(`[AvatarAnimator] Sequence too long (${sequence.length}), limiting to 5 animations`),sequence=sequence.slice(0,5));const validSequence=sequence.filter(name=>this.actions[name]);if(0===validSequence.length)return console.error("[AvatarAnimator] No valid animations in sequence, defaulting to idle"),void this.idle();if(this.isTransitioning)return void setTimeout(()=>{this.playSequence(sequence,options)},100);this.currentSequence=[...validSequence],this.sequenceIndex=0;const firstAnimationOptions={fadeInDuration:.6,fadeOutDuration:.6,loopCount:1,timeScale:options.timeScale??this.timeScale},firstAnimation=validSequence[0];this.play(firstAnimation,firstAnimationOptions)}forceIdle(){const idleAnimations=this.getAnimationsByCategory("IDLE");if(idleAnimations.length>0){const forcedIdle=idleAnimations[0].name;this.play(forcedIdle,{loopCount:0,fadeInDuration:.8,fadeOutDuration:.8}),this.currentIdleAnimation=forcedIdle,this.idleRotationCount=0}else console.error("[AvatarAnimator] No idle animations available for forced transition")}update(delta){if(!this.initialized||!this.mixer)return;const clampedDelta=Math.min(delta,.1);if(this.mixer.update(clampedDelta),!this.isTransitioning){if(this.currentSequence&&this.currentAnimation){const currentAction=this.actions[this.currentAnimation];if(currentAction){const clipDuration=currentAction.getClip().duration;if(currentAction.time/clipDuration>.85&&!this.isTransitioning)if(this.sequenceIndex<this.currentSequence.length-1){this.sequenceIndex++;const nextAnimation=this.currentSequence[this.sequenceIndex];this.play(nextAnimation,{fadeInDuration:.5,fadeOutDuration:.5,loopCount:1})}else this.currentSequence=null,this.sequenceIndex=0,this.idle({fadeInDuration:.7,fadeOutDuration:.7})}}if(this.currentAnimation&&this.currentIdleAnimation&&"IDLE"===this.getAnimationCategory()){const currentAction=this.actions[this.currentAnimation];if(currentAction){const clipDuration=currentAction.getClip().duration,currentTime=currentAction.time%clipDuration;(this.lastAnimationTime||0)>currentTime+.1&&(this.idleRotationCount++,this.idleRotationCount>=this.idleRotationLimit&&(this.idleRotationCount=0,this.idle({fadeInDuration:.6,fadeOutDuration:.6}))),this.lastAnimationTime=currentTime}}}}setupMixerEvents(){this.mixer?(this.mixer.addEventListener("loop",event=>{const action=event.action;action&&this.currentAnimation&&action===this.actions[this.currentAnimation]&&this.emit("loop",{animation:this.currentAnimation})}),this.mixer.addEventListener("finished",event=>{const action=event.action;if(action&&this.currentAnimation&&action===this.actions[this.currentAnimation]){if(this.isTransitioning)return;this.emit("complete",{animation:this.currentAnimation}),setTimeout(()=>{this.currentSequence&&this.sequenceIndex<this.currentSequence.length-1?(this.sequenceIndex++,this.play(this.currentSequence[this.sequenceIndex],{fadeInDuration:.5,fadeOutDuration:.5,loopCount:1})):this.currentSequence&&this.sequenceIndex>=this.currentSequence.length-1?(this.currentSequence=null,this.sequenceIndex=0,this.idle({fadeInDuration:.7,fadeOutDuration:.7})):this.currentAnimation&&"IDLE"!==this.getAnimationInfo(this.currentAnimation)?.category&&this.idle({fadeInDuration:.7,fadeOutDuration:.7})},50)}})):console.warn("[AvatarAnimator] Cannot setup mixer events - mixer not initialized")}setTimeScale(timeScale){if(this.timeScale=timeScale,this.currentAnimation){const currentAction=this.actions[this.currentAnimation];currentAction&&(currentAction.timeScale=timeScale)}}getRandomAnimation(category,exclude=[]){const filteredAnimations=Array.from(this.animations.values()).filter(info=>info.category===category&&!exclude.includes(info.name));if(0===filteredAnimations.length)return null;return filteredAnimations[Math.floor(Math.random()*filteredAnimations.length)].name}getAnimationInfo(name){return this.animations.get(name)||null}getAnimationCategory(){return this.currentAnimation&&this.getAnimationInfo(this.currentAnimation)?.category||null}on(event,callback){this.eventListeners[event]&&this.eventListeners[event].push(callback)}off(event,callback){this.eventListeners[event]&&(this.eventListeners[event]=this.eventListeners[event].filter(cb=>cb!==callback))}emit(event,data){this.eventListeners[event]&&this.eventListeners[event].forEach(callback=>{try{callback(data)}catch(error){console.error(`Error in ${event} event handler:`,error)}})}getCurrentAnimationName(){return this.currentAnimation}getAvatarType(){return this.avatarType}isInitialized(){return this.initialized}getAllAnimationNames(){return Array.from(this.animations.keys())}getAnimationsByCategory(category){return Array.from(this.animations.values()).filter(info=>info.category===category)}}var ContactShadows=__webpack_require__("./node_modules/@react-three/drei/core/ContactShadows.js"),jsx_runtime=__webpack_require__("./node_modules/react/jsx-runtime.js");const DynamicShadow=({animator,avatarPosition})=>{const shadowProps=(()=>{const baseProps={width:10,height:10,blur:2.5,scale:10,far:5,resolution:1024,color:"#000000"};return animator?animator.getCurrentAnimationName()?.startsWith("Loading")?{...baseProps,opacity:.85,blur:3,width:12,height:12}:animator.getCurrentAnimationName()?.includes("Gioia")||animator.getCurrentAnimationName()?.includes("Joy")?{...baseProps,opacity:.9,blur:2,width:11,height:11}:animator.getCurrentAnimationName()?.includes("Rabbia")||animator.getCurrentAnimationName()?.includes("Anger")?{...baseProps,opacity:.95,blur:1.8,width:12,height:12}:{...baseProps,opacity:.9,blur:2.2}:{...baseProps,opacity:0}})();return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(ContactShadows._,{opacity:shadowProps.opacity,scale:shadowProps.scale,blur:shadowProps.blur,far:shadowProps.far,resolution:shadowProps.resolution,color:shadowProps.color,frames:1/0,position:[0,avatarPosition.y,0]}),(0,jsx_runtime.jsx)(ContactShadows._,{opacity:1,width:5,height:5,blur:1,far:2,resolution:1024,color:"#000000",position:[0,-.98,0]})]})},Shadow_DynamicShadow=DynamicShadow;try{DynamicShadow.displayName="DynamicShadow",DynamicShadow.__docgenInfo={description:"",displayName:"DynamicShadow",props:{animator:{defaultValue:null,description:"",name:"animator",required:!0,type:{name:"AvatarAnimator | null"}},avatarPosition:{defaultValue:null,description:"",name:"avatarPosition",required:!0,type:{name:"any"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/Avatar/AvatarView/AvatarComponent/Shadow/DynamicShadow.tsx#DynamicShadow"]={docgenInfo:DynamicShadow.__docgenInfo,name:"DynamicShadow",path:"src/components/Avatar/AvatarView/AvatarComponent/Shadow/DynamicShadow.tsx#DynamicShadow"})}catch(__react_docgen_typescript_loader_error){}function FullbodyAvatar({url,sex,eyeBlink,updateCurrentViseme,avatarHeight=50,avatarDepth=0,onCameraZChange,chatEmission,loading,setAnimatorRef}){const{scene,animations:baseAnimations}=(0,useGLTF.p)(url),{animations:additionalAnimations}=(0,useGLTF.p)(ANIMATION_URLS[sex]),needsAdditionalAnimations=(0,react.useMemo)(()=>{let found=!1;return scene.traverse(object=>{object instanceof three_module.SkinnedMesh&&("GBNL__Head"===object.name||"Wolf3D_Avatar"===object.name||"Wolf3D_Avatar006_1"===object.name)&&(found=!0)}),found},[scene]),mergedAnimations=(0,react.useMemo)(()=>needsAdditionalAnimations?[...baseAnimations,...additionalAnimations]:baseAnimations,[baseAnimations,additionalAnimations,needsAdditionalAnimations]),{actions}=(0,useAnimations.f)(mergedAnimations,scene),morphTargetControllerRef=(0,react.useRef)(null),positionControllerRef=(0,react.useRef)(null),animatorRef=(0,react.useRef)(null),isInitializedRef=(0,react.useRef)(!1),lastPositionRef=(0,react.useRef)(AVATAR_POSITION.clone()),positionUpdateThrottleRef=(0,react.useRef)(0),[isRpm,setIsRpm]=(0,react.useState)(!1),blinkStateRef=(0,react.useRef)({isBlinking:!1,lastBlinkTime:0,nextBlinkTime:0,blinkStartTime:0});(0,react.useEffect)(()=>{if(!scene)return;let headMesh=null;scene.traverse(object=>{if(object instanceof three_module.SkinnedMesh){if("Wolf3D_Avatar"===object.name||"Wolf3D_Avatar006_1"===object.name)return setIsRpm(!0),void(headMesh=object);if("GBNL__Head"===object.name)headMesh=object;else{if(object.morphTargetDictionary&&Object.keys(object.morphTargetDictionary).length>0){const morphTargetNames=Object.keys(object.morphTargetDictionary||{}),hasVisemes=morphTargetNames.some(name=>name.toLowerCase().includes("viseme")),hasFaceBlendShapes=morphTargetNames.some(name=>{const lower=name.toLowerCase();return lower.includes("mouth")||lower.includes("eye")||lower.includes("jaw")||lower.includes("smile")});(hasVisemes||hasFaceBlendShapes)&&(headMesh=object)}}}}),headMesh?morphTargetControllerRef.current||(morphTargetControllerRef.current=new MorphTargetController(headMesh)):console.warn("⚠️ No suitable avatar mesh found")},[scene]),(0,react.useEffect)(()=>(positionControllerRef.current||(positionControllerRef.current=new AvatarPositionController(AVATAR_POSITION)),()=>{}),[]),(0,react.useEffect)(()=>{positionControllerRef.current&&positionControllerRef.current.updateHeight(avatarHeight,!1)},[avatarHeight]),(0,react.useEffect)(()=>{if(positionControllerRef.current&&onCameraZChange){const newCameraZ=positionControllerRef.current.updateDepth(avatarDepth,!1);onCameraZChange(newCameraZ)}},[avatarDepth,onCameraZChange]),(0,react.useEffect)(()=>{if(!scene||!actions||isInitializedRef.current)return;animatorRef.current||(animatorRef.current=new AvatarAnimator);const animator=animatorRef.current;return(async()=>{try{if(animator.isInitialized())return;await animator.initialize(scene,actions,mergedAnimations,isRpm?"RPM":"CUSTOM_GLB"),setAnimatorRef&&setAnimatorRef(animator),isInitializedRef.current=!0,animator.setTimeScale(.8)}catch(error){console.error("Error initializing AvatarAnimator:",error)}})(),()=>{animatorRef.current&&isInitializedRef.current&&("mixer"in animatorRef.current&&animatorRef.current.mixer&&animatorRef.current.mixer.stopAllAction(),setAnimatorRef&&setAnimatorRef(null),isInitializedRef.current=!1)}},[scene,actions,mergedAnimations,sex,setAnimatorRef]);const frameCallback=(0,react.useCallback)((state,delta)=>{const currentTime=1e3*state.clock.elapsedTime;if(animatorRef.current&&isInitializedRef.current&&animatorRef.current.update(delta),morphTargetControllerRef.current){const currentViseme=updateCurrentViseme(currentTime/1e3);morphTargetControllerRef.current.updateMorphTargets(currentTime,chatEmission,loading,currentViseme,eyeBlink,blinkStateRef.current)}if(scene&&positionControllerRef.current){const newScale=positionControllerRef.current.updateScale(.1);if(scene.scale.copy(newScale),currentTime-positionUpdateThrottleRef.current>=1){const currentPosition=positionControllerRef.current.getPosition();currentPosition.setX(Number(currentPosition.x.toFixed(6))),currentPosition.setY(Number(currentPosition.y.toFixed(6))),currentPosition.setZ(Number(currentPosition.z.toFixed(6))),lastPositionRef.current.copy(currentPosition),positionUpdateThrottleRef.current=currentTime}}},[scene,updateCurrentViseme,chatEmission,loading,eyeBlink]);(0,react_three_fiber_esm.j$)(frameCallback);const position=(0,react.useMemo)(()=>positionControllerRef.current?.getPosition()||AVATAR_POSITION.clone(),[]);return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)(Shadow_DynamicShadow,{animator:animatorRef.current,avatarPosition:position}),(0,jsx_runtime.jsx)("group",{position,rotation:AVATAR_ROTATION,children:(0,jsx_runtime.jsx)("primitive",{object:scene})})]})}try{FullbodyAvatar.displayName="FullbodyAvatar",FullbodyAvatar.__docgenInfo={description:"",displayName:"FullbodyAvatar",props:{url:{defaultValue:null,description:"",name:"url",required:!0,type:{name:"string"}},sex:{defaultValue:null,description:"",name:"sex",required:!0,type:{name:"enum",value:[{value:'"MALE"'},{value:'"FEMALE"'}]}},eyeBlink:{defaultValue:null,description:"",name:"eyeBlink",required:!0,type:{name:"boolean"}},updateCurrentViseme:{defaultValue:null,description:"",name:"updateCurrentViseme",required:!0,type:{name:"(currentTime: number) => { name: string; weight: number; } | null"}},avatarHeight:{defaultValue:{value:"50"},description:"",name:"avatarHeight",required:!1,type:{name:"number"}},avatarDepth:{defaultValue:{value:"0"},description:"",name:"avatarDepth",required:!1,type:{name:"number"}},onCameraZChange:{defaultValue:null,description:"",name:"onCameraZChange",required:!1,type:{name:"((value: number) => void)"}},chatEmission:{defaultValue:null,description:"",name:"chatEmission",required:!0,type:{name:"any"}},loading:{defaultValue:null,description:"",name:"loading",required:!0,type:{name:"boolean"}},setAnimatorRef:{defaultValue:null,description:"",name:"setAnimatorRef",required:!1,type:{name:"((animator: AvatarAnimator | null) => void)"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/Avatar/AvatarView/AvatarComponent/components/FullbodyAvatar/fullbodyAvatar.tsx#FullbodyAvatar"]={docgenInfo:FullbodyAvatar.__docgenInfo,name:"FullbodyAvatar",path:"src/components/Avatar/AvatarView/AvatarComponent/components/FullbodyAvatar/fullbodyAvatar.tsx#FullbodyAvatar"})}catch(__react_docgen_typescript_loader_error){}var utils=__webpack_require__("./src/helpers/utils.ts");const lerp=(start,end,time=.05)=>start*(1-time)+end*time,mapRange=(value,inMin,inMax,outMin,outMax)=>((value=((value,min,max)=>Math.min(Math.max(value,min),max))(value,inMin,inMax))-inMin)*(outMax-outMin)/(inMax-inMin)+outMin,rad=Math.PI/180;let timeout,useHeadMovement_reset=!1;const targetPos=new three_module.Vector2(0,0),currentPos=new three_module.Vector2(0,0),setResetTrue=()=>{timeout=setTimeout(()=>{useHeadMovement_reset=!0},1e3)},setResetFalse=()=>{clearTimeout(timeout),useHeadMovement_reset=!1};function HalfBodyAvatar({url,updateCurrentViseme,eyeBlink=!1,avatarHeight=50,avatarDepth=0,headMovement=!1,onLoaded,onCameraZChange,chatEmission,loading=!1}){const{scene}=(0,useGLTF.p)(url),{nodes,materials}=(0,react_three_fiber_esm.uU)(scene),{camera}=(0,react_three_fiber_esm.yk)(),morphTargetControllerRef=(0,react.useRef)(null),positionControllerRef=(0,react.useRef)(null);(0,react.useRef)(camera.position.z);!function useHeadMovement(enabled,nodes){const{gl}=(0,react_three_fiber_esm.yk)();(0,react.useEffect)(()=>{if(enabled)return gl.domElement.addEventListener("mouseleave",setResetTrue),gl.domElement.addEventListener("mouseenter",setResetFalse),()=>{gl.domElement.removeEventListener("mouseleave",setResetTrue),gl.domElement.removeEventListener("mouseenter",setResetFalse)}},[gl.domElement,enabled]),(0,react_three_fiber_esm.j$)(state=>{if(!enabled||!nodes?.Neck||!nodes?.Head)return;const cameraRotation=Math.abs(state.camera.rotation.z);!useHeadMovement_reset&&cameraRotation<.2?(targetPos.x=mapRange(state.mouse.y,-1,1,5*rad,-5*rad),targetPos.y=mapRange(state.mouse.x,-1,1,-10*rad,10*rad)):targetPos.set(0,0),currentPos.x=lerp(currentPos.x,targetPos.x),currentPos.y=lerp(currentPos.y,targetPos.y),nodes.Neck.rotation.x=currentPos.x+.1,nodes.Neck.rotation.y=currentPos.y,nodes.Head.rotation.x=2*currentPos.x,nodes.Head.rotation.y=2*currentPos.y})}(headMovement,nodes);const blinkStateRef=(0,react.useRef)({isBlinking:!1,lastBlinkTime:0,nextBlinkTime:0,blinkStartTime:0}),headMesh=(0,react.useMemo)(()=>{let foundMesh;return scene?.traverse(object=>{object instanceof three_module.SkinnedMesh&&("GBNL__Head"===object.name||"Wolf3D_Avatar"===object.name||"Wolf3D_Avatar006_1"===object.name)&&(foundMesh=object)}),foundMesh},[scene]);(0,react.useEffect)(()=>(positionControllerRef.current||(positionControllerRef.current=new AvatarPositionController(AVATAR_POSITION,AVATAR_POSITION_ZOOMED)),headMesh&&(morphTargetControllerRef.current=new MorphTargetController(headMesh)),(0,utils.DN)(materials),onLoaded?.(),(nodes=>{nodes.Wolf3D_Hands&&(nodes.Wolf3D_Hands.visible=!1),nodes.RightHand&&nodes.LeftHand&&(nodes.RightHand.position.set(0,-2,0),nodes.LeftHand.position.set(0,-2,0))})(nodes),()=>{Object.values(materials).forEach(material=>material.dispose()),Object.values(nodes).filter(utils.GZ).forEach(mesh=>mesh.geometry.dispose())}),[materials,nodes,url,onLoaded,scene,headMesh]),(0,react.useEffect)(()=>{positionControllerRef.current&&positionControllerRef.current.updateHeight(avatarHeight,!0)},[avatarHeight]),(0,react.useEffect)(()=>{if(positionControllerRef.current&&onCameraZChange){const newCameraZ=positionControllerRef.current.updateDepth(avatarDepth,!0);onCameraZChange(newCameraZ)}},[avatarDepth,onCameraZChange]),(0,react_three_fiber_esm.j$)(state=>{const currentTime=1e3*state.clock.elapsedTime;if(morphTargetControllerRef.current){const currentViseme=updateCurrentViseme(currentTime/1e3);morphTargetControllerRef.current.updateMorphTargets(currentTime,chatEmission,loading,currentViseme,eyeBlink,blinkStateRef.current)}if(scene&&positionControllerRef.current){const newScale=positionControllerRef.current.updateScale(.1);scene.scale.copy(newScale)}});const position=positionControllerRef.current?.getPosition()||AVATAR_POSITION;return(0,jsx_runtime.jsx)("group",{position,children:(0,jsx_runtime.jsx)("primitive",{object:scene})})}HalfBodyAvatar.displayName="HalfBodyAvatar";try{halfbodyAvatar.displayName="halfbodyAvatar",halfbodyAvatar.__docgenInfo={description:"",displayName:"halfbodyAvatar",props:{url:{defaultValue:null,description:"",name:"url",required:!0,type:{name:"string"}},updateCurrentViseme:{defaultValue:null,description:"",name:"updateCurrentViseme",required:!0,type:{name:"(currentTime: number) => any"}},eyeBlink:{defaultValue:{value:"false"},description:"",name:"eyeBlink",required:!1,type:{name:"boolean"}},avatarHeight:{defaultValue:{value:"50"},description:"",name:"avatarHeight",required:!1,type:{name:"number"}},avatarDepth:{defaultValue:{value:"0"},description:"",name:"avatarDepth",required:!1,type:{name:"number"}},onLoaded:{defaultValue:null,description:"",name:"onLoaded",required:!1,type:{name:"(() => void)"}},onCameraZChange:{defaultValue:null,description:"",name:"onCameraZChange",required:!0,type:{name:"(value: number) => void"}},headMovement:{defaultValue:{value:"false"},description:"",name:"headMovement",required:!1,type:{name:"boolean"}},chatEmission:{defaultValue:null,description:"",name:"chatEmission",required:!1,type:{name:"any"}},loading:{defaultValue:{value:"false"},description:"",name:"loading",required:!1,type:{name:"boolean"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/Avatar/AvatarView/AvatarComponent/components/halfbodyAvatar.tsx#halfbodyAvatar"]={docgenInfo:halfbodyAvatar.__docgenInfo,name:"halfbodyAvatar",path:"src/components/Avatar/AvatarView/AvatarComponent/components/halfbodyAvatar.tsx#halfbodyAvatar"})}catch(__react_docgen_typescript_loader_error){}const MemoizedFullbodyAvatar=(0,react.memo)(FullbodyAvatar),MemoizedHalfBodyAvatar=(0,react.memo)(HalfBodyAvatar),avatarComponent_AvatarView=({chatEmission,url,sex,eyeBlink,halfBody,loading,avatarHeight=50,avatarDepth=-50,updateCurrentViseme,setCameraZ,headMovement,showControls})=>{const animatorRef=(0,react.useRef)(null),setAnimatorRef=(0,react.useCallback)(animator=>{animator!==animatorRef.current&&(animatorRef.current=animator)},[]);(0,react.useEffect)(()=>{if(animatorRef.current)try{animatorRef.current.processChatEmission(chatEmission,loading)}catch(error){console.error("Error processing chat emission:",error)}},[loading,chatEmission]);const commonAvatarProps=(0,react.useCallback)(()=>({url,onCameraZChange:setCameraZ,updateCurrentViseme,avatarHeight,avatarDepth,setAnimatorRef}),[url,setCameraZ,updateCurrentViseme,avatarHeight,avatarDepth,setAnimatorRef]);return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[halfBody?(0,jsx_runtime.jsx)(MemoizedHalfBodyAvatar,{...commonAvatarProps(),eyeBlink,headMovement}):(0,jsx_runtime.jsx)(MemoizedFullbodyAvatar,{...commonAvatarProps(),sex,eyeBlink,chatEmission,loading}),showControls&&animatorRef.current&&(0,jsx_runtime.jsx)("div",{className:"animation-controls"})]})};try{avatarComponent_AvatarView.displayName="AvatarView",avatarComponent_AvatarView.__docgenInfo={description:"",displayName:"AvatarView",props:{chatEmission:{defaultValue:null,description:"",name:"chatEmission",required:!0,type:{name:"string | null | undefined"}},url:{defaultValue:null,description:"",name:"url",required:!0,type:{name:"string"}},sex:{defaultValue:null,description:"",name:"sex",required:!0,type:{name:"enum",value:[{value:'"MALE"'},{value:'"FEMALE"'}]}},eyeBlink:{defaultValue:null,description:"",name:"eyeBlink",required:!0,type:{name:"boolean"}},halfBody:{defaultValue:null,description:"",name:"halfBody",required:!0,type:{name:"boolean"}},loading:{defaultValue:null,description:"",name:"loading",required:!0,type:{name:"boolean"}},avatarHeight:{defaultValue:{value:"50"},description:"",name:"avatarHeight",required:!1,type:{name:"number"}},avatarDepth:{defaultValue:{value:"-50"},description:"",name:"avatarDepth",required:!1,type:{name:"number"}},updateCurrentViseme:{defaultValue:null,description:"",name:"updateCurrentViseme",required:!0,type:{name:"(currentTime: number) => { name: string; weight: number; } | null"}},setCameraZ:{defaultValue:null,description:"",name:"setCameraZ",required:!0,type:{name:"(cameraZ: number) => void"}},headMovement:{defaultValue:null,description:"",name:"headMovement",required:!0,type:{name:"boolean"}},speaking:{defaultValue:null,description:"",name:"speaking",required:!0,type:{name:"boolean"}},showControls:{defaultValue:null,description:"",name:"showControls",required:!0,type:{name:"boolean"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/Avatar/AvatarView/AvatarComponent/avatarComponent.tsx#AvatarView"]={docgenInfo:avatarComponent_AvatarView.__docgenInfo,name:"AvatarView",path:"src/components/Avatar/AvatarView/AvatarComponent/avatarComponent.tsx#AvatarView"})}catch(__react_docgen_typescript_loader_error){}var configuration=__webpack_require__("./src/helpers/configuration.ts"),useTranslation=__webpack_require__("./node_modules/react-i18next/dist/es/useTranslation.js"),Slider=__webpack_require__("./src/components/ui/Slider.tsx"),Button=__webpack_require__("./src/components/ui/Button.tsx"),Close=__webpack_require__("./src/components/icons/Close.tsx");const PositionControls=({avatarHeight,avatarDepth,setAvatarHeight,setAvatarDepth,halfBody,setEnablePositionControls})=>{const normalPosition=halfBody?{height:80,depth:50}:{height:25,depth:25},zoomedPosition=halfBody?{height:55,depth:10}:{height:15,depth:5},farPosition=halfBody?{height:100,depth:80}:{height:65,depth:100},settingsRef=(0,react.useRef)({height:avatarHeight,depth:avatarDepth,zoomed:!1,normal:!1,far:!1}),{t}=(0,useTranslation.B)();return(0,react.useEffect)(()=>{settingsRef.current.height=avatarHeight,settingsRef.current.depth=avatarDepth},[avatarHeight,avatarDepth]),(0,react.useEffect)(()=>{const handleKeyDown=event=>{if("-"===event.key||"_"===event.key&&settingsRef.current.depth<100){const newValue=Math.min(settingsRef.current.depth+10,100);setAvatarDepth(newValue),(0,configuration.yY)("avatarDepth",newValue)}else if(("+"===event.key||"="===event.key)&&settingsRef.current.depth>-100){const newValue=Math.max(settingsRef.current.depth-10,-100);setAvatarDepth(newValue),(0,configuration.yY)("avatarDepth",newValue)}};return window.addEventListener("keydown",handleKeyDown),()=>{window.removeEventListener("keydown",handleKeyDown)}},[setAvatarDepth]),(0,react.useEffect)(()=>{const handleArrowUp=event=>{if("ArrowUp"===event.key&&settingsRef.current.height<100){const newValue=settingsRef.current.height+5;setAvatarHeight(newValue),(0,configuration.yY)("avatarHeight",newValue)}},handleArrowDown=event=>{if("ArrowDown"===event.key&&settingsRef.current.height>0){const newValue=settingsRef.current.height-5;setAvatarHeight(newValue),(0,configuration.yY)("avatarHeight",newValue)}};return window.addEventListener("keydown",handleArrowUp),window.addEventListener("keydown",handleArrowDown),()=>{window.removeEventListener("keydown",handleArrowUp),window.removeEventListener("keydown",handleArrowDown)}},[setAvatarHeight]),(0,jsx_runtime.jsxs)("div",{className:"memori--position-controls",children:[(0,jsx_runtime.jsx)("div",{className:"memori--position-controls-close",children:(0,jsx_runtime.jsx)(Button.A,{ghost:!0,icon:(0,jsx_runtime.jsx)(Close.default,{}),outlined:!0,danger:!0,shape:"circle",className:"memori--position-controls-close-button",onClick:()=>{setEnablePositionControls(!1)}})}),(0,jsx_runtime.jsx)(Slider.A,{defaultValue:settingsRef.current.height,min:.5,max:100,label:t("write_and_speak.height"),step:1,onChange:value=>{setAvatarHeight(value),(0,configuration.yY)("avatarHeight",value)}}),(0,jsx_runtime.jsx)(Slider.A,{defaultValue:settingsRef.current.depth,min:.5,max:100,step:5,label:t("write_and_speak.depth"),onChange:value=>{setAvatarDepth(value),(0,configuration.yY)("avatarDepth",value)}}),(0,jsx_runtime.jsxs)("div",{className:"memori--preset-buttons",children:[(0,jsx_runtime.jsx)(Button.A,{outlined:!0,isActive:avatarHeight===(halfBody?zoomedPosition.height:normalPosition.height)&&avatarDepth===(halfBody?zoomedPosition.depth:normalPosition.depth),onClick:()=>{setAvatarHeight(zoomedPosition.height),setAvatarDepth(zoomedPosition.depth),(0,configuration.yY)("avatarHeight",zoomedPosition.height),(0,configuration.yY)("avatarDepth",zoomedPosition.depth)},children:t("write_and_speak.zoomed")}),(0,jsx_runtime.jsx)(Button.A,{outlined:!0,isActive:avatarHeight===(halfBody?normalPosition.height:zoomedPosition.height)&&avatarDepth===(halfBody?normalPosition.depth:zoomedPosition.depth),onClick:()=>{setAvatarHeight(normalPosition.height),setAvatarDepth(normalPosition.depth),(0,configuration.yY)("avatarHeight",normalPosition.height),(0,configuration.yY)("avatarDepth",normalPosition.depth)},children:t("write_and_speak.normal")}),(0,jsx_runtime.jsx)(Button.A,{outlined:!0,isActive:avatarHeight===(halfBody?farPosition.height:normalPosition.height)&&avatarDepth===(halfBody?farPosition.depth:normalPosition.depth),onClick:()=>{setAvatarHeight(farPosition.height),setAvatarDepth(farPosition.depth),(0,configuration.yY)("avatarHeight",farPosition.height),(0,configuration.yY)("avatarDepth",farPosition.depth)},children:t("write_and_speak.far")})]})]})};PositionControls.displayName="PositionControls";const positionControls_positionControls=PositionControls;try{positionControls.displayName="positionControls",positionControls.__docgenInfo={description:"",displayName:"positionControls",props:{avatarHeight:{defaultValue:null,description:"",name:"avatarHeight",required:!0,type:{name:"number"}},avatarDepth:{defaultValue:null,description:"",name:"avatarDepth",required:!0,type:{name:"number"}},halfBody:{defaultValue:null,description:"",name:"halfBody",required:!0,type:{name:"boolean"}},setAvatarHeight:{defaultValue:null,description:"",name:"setAvatarHeight",required:!0,type:{name:"(value: number) => void"}},setAvatarDepth:{defaultValue:null,description:"",name:"setAvatarDepth",required:!0,type:{name:"(value: number) => void"}},setEnablePositionControls:{defaultValue:null,description:"",name:"setEnablePositionControls",required:!0,type:{name:"(value: boolean) => void"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/Avatar/AvatarView/AvatarComponent/positionControls/positionControls.tsx#positionControls"]={docgenInfo:positionControls.__docgenInfo,name:"positionControls",path:"src/components/Avatar/AvatarView/AvatarComponent/positionControls/positionControls.tsx#positionControls"})}catch(__react_docgen_typescript_loader_error){}var useProgress=__webpack_require__("./node_modules/@react-three/drei/core/useProgress.js"),Html=__webpack_require__("./node_modules/@react-three/drei/web/Html.js"),Spin=__webpack_require__("./src/components/ui/Spin.tsx");const Loader=({fallbackImg})=>{const{progress}=(0,useProgress.p)();return(0,jsx_runtime.jsx)(Html.E,{center:!0,className:"avatar-loader",children:(0,jsx_runtime.jsx)(Spin.A,{spinning:!0,children:fallbackImg?(0,jsx_runtime.jsxs)("figure",{children:[(0,jsx_runtime.jsx)("img",{src:fallbackImg,alt:`${Math.round(progress)}% loaded`,title:`${Math.round(progress)}% loaded`}),(0,jsx_runtime.jsx)("figcaption",{children:`${Math.round(progress)}%`})]}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[Math.round(progress)," % loaded"]})})})};Loader.displayName="Loader";const components_loader=Loader;try{loader.displayName="loader",loader.__docgenInfo={description:"",displayName:"loader",props:{fallbackImg:{defaultValue:null,description:"",name:"fallbackImg",required:!1,type:{name:"string"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/Avatar/AvatarView/AvatarComponent/components/loader.tsx#loader"]={docgenInfo:loader.__docgenInfo,name:"loader",path:"src/components/Avatar/AvatarView/AvatarComponent/components/loader.tsx#loader"})}catch(__react_docgen_typescript_loader_error){}const definedProps=obj=>{return arr=Object.entries(obj).filter(([_,v])=>void 0!==v),Object.assign({},...arr.map(([k,v])=>({[k]:v})));var arr},LIGHT_CONFIG=Object.freeze({fillLightAngle:Math.PI/3,backLightAngle:Math.PI/8,keyLightAngle:Math.PI/2,silhouetteLightAngle:1.25*Math.PI,keyLightPosition:new three_module.Vector3(.75,1.75,.75),liftLightPosition:new three_module.Vector3(.25,1.5,2),dirLightPosition:new three_module.Vector3(-.75,2.5,-1),silhouetteLightPosition:new three_module.Vector3(-1.25,.25,-1.25),defaultProps:{keyLightIntensity:1.2,keyLightColor:"#FFF5EB",fillLightIntensity:2.5,fillLightColor:"#A4C4FF",fillLightPosition:new three_module.Vector3(-.6,1.7,-.4),backLightIntensity:4,backLightColor:"#FFD4A8",backLightPosition:new three_module.Vector3(.6,1.7,-1),lightTarget:new three_module.Vector3(0,1.65,0)}}),Lights=lightingProps=>{const{keyLightIntensity,keyLightColor,fillLightIntensity,fillLightColor,fillLightPosition,backLightIntensity,backLightColor,backLightPosition,lightTarget}=Object.assign(LIGHT_CONFIG.defaultProps,definedProps(lightingProps)),{scene}=(0,react_three_fiber_esm.yk)(),[targets]=(0,react.useState)({head:new three_module.Object3D,shoe:new three_module.Object3D});return(0,react.useEffect)(()=>(targets.head.position.copy(lightTarget),targets.shoe.position.set(0,.1,0),scene.add(targets.head),scene.add(targets.shoe),()=>{scene.remove(targets.head),scene.remove(targets.shoe)}),[scene,targets,lightTarget]),(0,jsx_runtime.jsxs)("group",{children:[(0,jsx_runtime.jsx)("spotLight",{position:fillLightPosition,target:targets.head,angle:LIGHT_CONFIG.fillLightAngle,color:fillLightColor,intensity:fillLightIntensity,castShadow:!0,"shadow-bias":-1e-4,penumbra:.2}),(0,jsx_runtime.jsx)("spotLight",{position:backLightPosition,target:targets.head,angle:LIGHT_CONFIG.backLightAngle,color:backLightColor,intensity:backLightIntensity,castShadow:!0,"shadow-bias":-1e-4,penumbra:.2}),(0,jsx_runtime.jsx)("spotLight",{position:LIGHT_CONFIG.keyLightPosition,target:targets.head,angle:LIGHT_CONFIG.keyLightAngle,color:keyLightColor,intensity:keyLightIntensity,penumbra:.3,castShadow:!0}),(0,jsx_runtime.jsx)("spotLight",{position:LIGHT_CONFIG.liftLightPosition,target:targets.shoe,angle:LIGHT_CONFIG.keyLightAngle,color:keyLightColor,intensity:.3*keyLightIntensity,penumbra:.4}),(0,jsx_runtime.jsx)("spotLight",{position:LIGHT_CONFIG.silhouetteLightPosition,target:targets.head,angle:LIGHT_CONFIG.silhouetteLightAngle,color:keyLightColor,intensity:.3*keyLightIntensity,penumbra:.3}),(0,jsx_runtime.jsx)("ambientLight",{intensity:.2,color:"#FFF8EF"})]})};Lights.displayName="Lights";const lights_Lights=Lights;try{definedProps.displayName="definedProps",definedProps.__docgenInfo={description:"",displayName:"definedProps",props:{}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/Avatar/AvatarView/AvatarComponent/lights/Lights.tsx#definedProps"]={docgenInfo:definedProps.__docgenInfo,name:"definedProps",path:"src/components/Avatar/AvatarView/AvatarComponent/lights/Lights.tsx#definedProps"})}catch(__react_docgen_typescript_loader_error){}try{Lights.displayName="Lights",Lights.__docgenInfo={description:"",displayName:"Lights",props:{keyLightIntensity:{defaultValue:null,description:"",name:"keyLightIntensity",required:!1,type:{name:"number"}},keyLightColor:{defaultValue:null,description:"",name:"keyLightColor",required:!1,type:{name:"string"}},fillLightIntensity:{defaultValue:null,description:"",name:"fillLightIntensity",required:!1,type:{name:"number"}},fillLightColor:{defaultValue:null,description:"",name:"fillLightColor",required:!1,type:{name:"string"}},fillLightPosition:{defaultValue:null,description:"",name:"fillLightPosition",required:!1,type:{name:"Vector3"}},backLightIntensity:{defaultValue:null,description:"",name:"backLightIntensity",required:!1,type:{name:"number"}},backLightColor:{defaultValue:null,description:"",name:"backLightColor",required:!1,type:{name:"string"}},backLightPosition:{defaultValue:null,description:"",name:"backLightPosition",required:!1,type:{name:"Vector3"}},lightTarget:{defaultValue:null,description:"The position in space which is used by the lights to shine at. (Defaults to approximate head height)",name:"lightTarget",required:!1,type:{name:"Vector3"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/Avatar/AvatarView/AvatarComponent/lights/Lights.tsx#Lights"]={docgenInfo:Lights.__docgenInfo,name:"Lights",path:"src/components/Avatar/AvatarView/AvatarComponent/lights/Lights.tsx#Lights"})}catch(__react_docgen_typescript_loader_error){}const defaultStyles={halfBody:{width:"100%",height:"100%",minHeight:"500px",backgroundColor:"white",borderRadius:"100%"},fullBody:{width:"500px",height:"500px",backgroundColor:"white"}},getCameraSettings=(halfBody,isZoomed)=>({fov:isZoomed?44:40,position:[0,0,halfBody?.6:3],target:[0,0,0]});function ContainerAvatarView({url,sex,style,rotateAvatar,eyeBlink,headMovement,speaking,fallback,fallbackImg,halfBody=!0,loading,showControls=!1,isZoomed,chatEmission,updateCurrentViseme,enablePositionControls,setEnablePositionControls,isTotem=!1}){const[cameraZ,setCameraZ]=(0,react.useState)(()=>getCameraSettings(halfBody,isZoomed||!1).position[2]),[avatarHeight,setAvatarHeight]=(0,react.useState)((()=>{if(isTotem){return(0,configuration.uY)("avatarHeight",50)}return halfBody?80:isZoomed?16:65})()),[avatarDepth,setAvatarDepth]=(0,react.useState)((()=>{if(isTotem){return(0,configuration.uY)("avatarDepth",50)}return halfBody?50:isZoomed?5:100})());return(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[enablePositionControls&&(0,jsx_runtime.jsx)(positionControls_positionControls,{avatarHeight,avatarDepth,halfBody,setAvatarHeight,setAvatarDepth,setEnablePositionControls}),(0,jsx_runtime.jsxs)(react_three_fiber_esm.Hl,{style:style||defaultStyles.fullBody,shadows:!0,dpr:[1,2],gl:{antialias:!0,alpha:!0,powerPreference:"high-performance",stencil:!1},children:[(0,jsx_runtime.jsx)(PerspectiveCamera.u,{makeDefault:!0,position:[0,0,cameraZ],fov:getCameraSettings(halfBody,isZoomed||!1).fov,near:.1,far:1e3}),rotateAvatar&&(0,jsx_runtime.jsx)(OrbitControls.N,{enablePan:!1,enableZoom:!1,target:[0,0,0],enableDamping:!0,dampingFactor:.05}),(0,jsx_runtime.jsxs)(react.Suspense,{fallback:fallback||(0,jsx_runtime.jsx)(components_loader,{fallbackImg}),children:[(0,jsx_runtime.jsx)(lights_Lights,{}),(0,jsx_runtime.jsx)(avatarComponent_AvatarView,{url,sex,showControls,loading:loading||!1,eyeBlink:eyeBlink||!1,headMovement:headMovement||!1,speaking:speaking||!1,halfBody,chatEmission,updateCurrentViseme,setCameraZ,avatarHeight,avatarDepth})]})]})]})}try{AvatarView.displayName="AvatarView",AvatarView.__docgenInfo={description:"",displayName:"AvatarView",props:{url:{defaultValue:null,description:"",name:"url",required:!0,type:{name:"string"}},sex:{defaultValue:null,description:"",name:"sex",required:!0,type:{name:"enum",value:[{value:'"MALE"'},{value:'"FEMALE"'}]}},fallbackImg:{defaultValue:null,description:"",name:"fallbackImg",required:!1,type:{name:"string"}},eyeBlink:{defaultValue:null,description:"",name:"eyeBlink",required:!1,type:{name:"boolean"}},headMovement:{defaultValue:null,description:"",name:"headMovement",required:!1,type:{name:"boolean"}},rotateAvatar:{defaultValue:null,description:"",name:"rotateAvatar",required:!1,type:{name:"boolean"}},speaking:{defaultValue:null,description:"",name:"speaking",required:!1,type:{name:"boolean"}},style:{defaultValue:null,description:"",name:"style",required:!1,type:{name:"CSSProperties"}},fallback:{defaultValue:null,description:"",name:"fallback",required:!1,type:{name:"ReactNode"}},halfBody:{defaultValue:{value:"true"},description:"",name:"halfBody",required:!1,type:{name:"boolean"}},loading:{defaultValue:null,description:"",name:"loading",required:!1,type:{name:"boolean"}},animation:{defaultValue:null,description:"",name:"animation",required:!1,type:{name:"string"}},showControls:{defaultValue:{value:"false"},description:"",name:"showControls",required:!1,type:{name:"boolean"}},isZoomed:{defaultValue:null,description:"",name:"isZoomed",required:!1,type:{name:"boolean"}},chatEmission:{defaultValue:null,description:"",name:"chatEmission",required:!1,type:{name:"any"}},enablePositionControls:{defaultValue:null,description:"",name:"enablePositionControls",required:!1,type:{name:"boolean"}},setEnablePositionControls:{defaultValue:null,description:"",name:"setEnablePositionControls",required:!0,type:{name:"(value: boolean) => void"}},isTotem:{defaultValue:{value:"false"},description:"",name:"isTotem",required:!1,type:{name:"boolean"}},setMeshRef:{defaultValue:null,description:"",name:"setMeshRef",required:!1,type:{name:"any"}},stopProcessing:{defaultValue:null,description:"",name:"stopProcessing",required:!0,type:{name:"() => void"}},resetVisemeQueue:{defaultValue:null,description:"",name:"resetVisemeQueue",required:!0,type:{name:"() => void"}},updateCurrentViseme:{defaultValue:null,description:"",name:"updateCurrentViseme",required:!0,type:{name:"(currentTime: number) => { name: string; weight: number; } | null"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/Avatar/AvatarView/index.tsx#AvatarView"]={docgenInfo:AvatarView.__docgenInfo,name:"AvatarView",path:"src/components/Avatar/AvatarView/index.tsx#AvatarView"})}catch(__react_docgen_typescript_loader_error){}},"./src/components/ui/Slider.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>__WEBPACK_DEFAULT_EXPORT__});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/react/index.js"),_headlessui_react__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/@headlessui/react/dist/components/listbox/listbox.js"),classnames__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/classnames/index.js"),classnames__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(classnames__WEBPACK_IMPORTED_MODULE_2__),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./node_modules/react/jsx-runtime.js");const CustomSlider=({min=0,max=100,step=1,defaultValue=50,label,onChange,disabled=!1})=>{const[value,setValue]=(0,react__WEBPACK_IMPORTED_MODULE_0__.useState)(defaultValue),[isDragging,setIsDragging]=(0,react__WEBPACK_IMPORTED_MODULE_0__.useState)(!1),sliderRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(null),percentage=(value-min)/(max-min)*100,marks=[];for(let i=min;i<=max;i+=(max-min)/4)marks.push(Math.round(i));const calculateNewValue=clientX=>{if(!sliderRef.current)return value;const bounds=sliderRef.current.getBoundingClientRect(),position=clientX-bounds.left,sliderWidth=bounds.width,percentage=Math.max(0,Math.min(100,position/sliderWidth*100)),newValue=Math.round(percentage/100*(max-min)+min),steppedValue=Math.round(newValue/step)*step;return Math.min(Math.max(steppedValue,min),max)},handleInteractionStart=clientX=>{if(disabled)return;setIsDragging(!0);const newValue=calculateNewValue(clientX);setValue(newValue),onChange?.(newValue)},handleInteractionMove=clientX=>{if(!isDragging||disabled)return;const newValue=calculateNewValue(clientX);setValue(newValue),onChange?.(newValue)};return(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)(()=>{const handleTouchMove=e=>{isDragging&&(e.preventDefault(),handleInteractionMove(e.touches[0].clientX))},handleMouseMove=e=>{handleInteractionMove(e.clientX)},handleEndInteraction=()=>{setIsDragging(!1)};return isDragging&&(window.addEventListener("touchmove",handleTouchMove,{passive:!1}),window.addEventListener("mousemove",handleMouseMove),window.addEventListener("touchend",handleEndInteraction),window.addEventListener("mouseup",handleEndInteraction)),()=>{window.removeEventListener("touchmove",handleTouchMove),window.removeEventListener("mousemove",handleMouseMove),window.removeEventListener("touchend",handleEndInteraction),window.removeEventListener("mouseup",handleEndInteraction)}},[isDragging]),(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)(()=>{setValue(defaultValue)},[defaultValue]),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_3__.jsxs)("div",{className:classnames__WEBPACK_IMPORTED_MODULE_2___default()("memori--slider-container",{"memori--slider-disabled":disabled}),style:{"--percentage":`${percentage}%`},children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_3__.jsxs)("div",{className:"memori--slider-header",children:[label&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_3__.jsx)("div",{className:"memori--slider-label",children:label}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_3__.jsx)("div",{className:"memori--slider-value",children:value})]}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_3__.jsxs)("div",{ref:sliderRef,className:"memori--slider-track-container",onMouseDown:e=>handleInteractionStart(e.clientX),onTouchStart:e=>handleInteractionStart(e.touches[0].clientX),children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_3__.jsx)("div",{className:"memori--slider-track",children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_3__.jsx)("div",{className:"memori--slider-track-fill"})}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_3__.jsx)("div",{className:"memori--slider-marks",children:marks.map(mark=>(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_3__.jsxs)("div",{className:"memori--slider-mark",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_3__.jsx)("div",{className:"memori--slider-mark-line"}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_3__.jsx)("span",{className:"memori--slider-mark-value",children:mark})]},mark))}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_3__.jsx)(_headlessui_react__WEBPACK_IMPORTED_MODULE_1__.W,{value,onChange:setValue,disabled,children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_3__.jsx)("div",{className:"memori--slider-thumb",role:"slider","aria-valuemin":min,"aria-valuemax":max,"aria-valuenow":value,tabIndex:disabled?-1:0})})]})]})};CustomSlider.displayName="CustomSlider";const __WEBPACK_DEFAULT_EXPORT__=CustomSlider;try{Slider.displayName="Slider",Slider.__docgenInfo={description:"",displayName:"Slider",props:{min:{defaultValue:{value:"0"},description:"",name:"min",required:!1,type:{name:"number"}},max:{defaultValue:{value:"100"},description:"",name:"max",required:!1,type:{name:"number"}},step:{defaultValue:{value:"1"},description:"",name:"step",required:!1,type:{name:"number"}},defaultValue:{defaultValue:{value:"50"},description:"",name:"defaultValue",required:!1,type:{name:"number"}},label:{defaultValue:null,description:"",name:"label",required:!1,type:{name:"ReactNode"}},onChange:{defaultValue:null,description:"",name:"onChange",required:!1,type:{name:"((value: number) => void)"}},disabled:{defaultValue:{value:"false"},description:"",name:"disabled",required:!1,type:{name:"boolean"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/ui/Slider.tsx#Slider"]={docgenInfo:Slider.__docgenInfo,name:"Slider",path:"src/components/ui/Slider.tsx#Slider"})}catch(__react_docgen_typescript_loader_error){}},"./src/context/visemeContext.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{fy:()=>VisemeProvider,zE:()=>useViseme});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/react/index.js"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/react/jsx-runtime.js");const VisemeContext=(0,react__WEBPACK_IMPORTED_MODULE_0__.createContext)(void 0),VISEME_MAP={0:"viseme_sil",1:"viseme_PP",2:"viseme_FF",3:"viseme_TH",4:"viseme_DD",5:"viseme_kk",6:"viseme_CH",7:"viseme_SS",8:"viseme_nn",9:"viseme_RR",10:"viseme_aa",11:"viseme_E",12:"viseme_I",13:"viseme_O",14:"viseme_U",15:"viseme_kk",16:"viseme_CH",17:"viseme_SS",18:"viseme_TH",19:"viseme_RR",20:"viseme_kk",21:"viseme_PP"},{DEFAULT_VISEME_DURATION,VISEME_OVERLAP,SMOOTHING_FACTOR,LOG_INTERVAL,PRELOAD,WEIGHT_MULTIPLIER}={DEFAULT_VISEME_DURATION:.12,VISEME_OVERLAP:.02,SMOOTHING_FACTOR:.4,LOG_INTERVAL:60,PRELOAD:.2,WEIGHT_MULTIPLIER:.8},timing_isExpired=(viseme,currentTime)=>viseme.endTime<currentTime-VISEME_OVERLAP,timing_calculateWeight=progress=>Math.sin(Math.PI*Math.min(progress,1))*WEIGHT_MULTIPLIER,timing_smoothWeight=(currentWeight,targetWeight)=>currentWeight+(targetWeight-currentWeight)*SMOOTHING_FACTOR,VisemeProvider=({children})=>{const visemeQueueRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)([]),audioContextRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(null),audioStartTimeRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(null),[isProcessing,setIsProcessing]=(0,react__WEBPACK_IMPORTED_MODULE_0__.useState)(!1),[visemeState,setVisemeState]=(0,react__WEBPACK_IMPORTED_MODULE_0__.useState)("idle"),lastVisemeRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(null),frameCountRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(0),firstVisemeTimeRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(null),setAudioContext=(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)(ctx=>{audioContextRef.current=ctx,null!==ctx.onstatechange&&(ctx.onstatechange=()=>{switch(ctx.state){case"running":setVisemeState("active");break;case"suspended":setVisemeState("paused");break;case"closed":setVisemeState("finished"),stopProcessing()}})},[]),startProcessing=(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)(audioCtx=>{audioCtx?(audioContextRef.current=audioCtx,audioStartTimeRef.current=audioCtx.currentTime,frameCountRef.current=0,setIsProcessing(!0),setVisemeState("active")):console.error("[VisemeContext] No audio context provided")},[]),addViseme=(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)((visemeId,audioOffset)=>{if("finished"===visemeState)return;const visemeName=VISEME_MAP[visemeId]||"viseme_sil",startTime=audioOffset/1e7;null===firstVisemeTimeRef.current&&(firstVisemeTimeRef.current=startTime);const relativeStartTime=startTime-(firstVisemeTimeRef.current||0),newViseme={name:visemeName,weight:0,startTime:relativeStartTime,endTime:relativeStartTime+DEFAULT_VISEME_DURATION};visemeQueueRef.current.push(newViseme),"idle"===visemeState&&setVisemeState("preparing")},[visemeState]),resetVisemeQueue=(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)(()=>{visemeQueueRef.current=[],lastVisemeRef.current=null,audioStartTimeRef.current=null,firstVisemeTimeRef.current=null,frameCountRef.current=0,setVisemeState("idle")},[]),stopProcessing=(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)(()=>{setIsProcessing(!1),setVisemeState("finished"),audioStartTimeRef.current=null,lastVisemeRef.current=null,frameCountRef.current=0,audioContextRef.current=null},[]),updateCurrentViseme=(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)(_=>{if(!isProcessing||!audioContextRef.current)return null;const audioTime=audioContextRef.current.currentTime-(audioStartTimeRef.current||0)+PRELOAD;visemeQueueRef.current=visemeQueueRef.current.filter(v=>!timing_isExpired(v,audioTime));const currentViseme=visemeQueueRef.current.find(v=>v.startTime<=audioTime&&v.endTime>audioTime-VISEME_OVERLAP);if(currentViseme){const progress=(audioTime-currentViseme.startTime)/(currentViseme.endTime-currentViseme.startTime),targetWeight=timing_calculateWeight(progress),smoothedWeight=lastVisemeRef.current?timing_smoothWeight(lastVisemeRef.current.weight,targetWeight):targetWeight,updatedViseme={...currentViseme,weight:smoothedWeight};return lastVisemeRef.current=updatedViseme,updatedViseme}if(lastVisemeRef.current){const reducedWeight=lastVisemeRef.current.weight*(1-SMOOTHING_FACTOR);lastVisemeRef.current={...lastVisemeRef.current,weight:reducedWeight}}return lastVisemeRef.current=null,null},[isProcessing]),resetAndStartProcessing=(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)(audioCtx=>{stopProcessing(),resetVisemeQueue(),startProcessing(audioCtx)},[stopProcessing,resetVisemeQueue,startProcessing,visemeState]),contextValue=(0,react__WEBPACK_IMPORTED_MODULE_0__.useMemo)(()=>({addViseme,updateCurrentViseme,startProcessing,stopProcessing,resetAndStartProcessing,resetVisemeQueue,isProcessing,setAudioContext}),[addViseme,updateCurrentViseme,startProcessing,stopProcessing,resetAndStartProcessing,resetVisemeQueue,isProcessing,setAudioContext]);return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_1__.jsx)(VisemeContext.Provider,{value:contextValue,children})};VisemeProvider.displayName="VisemeProvider";const useViseme=()=>{const context=(0,react__WEBPACK_IMPORTED_MODULE_0__.useContext)(VisemeContext);if(!context)throw new Error("useVisemeContext must be used within a VisemeProvider");return context};try{VisemeProvider.displayName="VisemeProvider",VisemeProvider.__docgenInfo={description:"",displayName:"VisemeProvider",props:{}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/context/visemeContext.tsx#VisemeProvider"]={docgenInfo:VisemeProvider.__docgenInfo,name:"VisemeProvider",path:"src/context/visemeContext.tsx#VisemeProvider"})}catch(__react_docgen_typescript_loader_error){}},"./src/helpers/configuration.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{k4:()=>removeLocalConfig,uY:()=>getLocalConfig,yY:()=>setLocalConfig});const keys={muteSpeaker:"@memori:muteSpeaker",microphoneMode:"@memori:microphoneMode",continuousSpeechTimeout:"@memori:continuousSpeechTimeout",birthDate:"@memori:birthDate",controlsPosition:"@memori:controlsPosition",hideEmissions:"@memori:hideEmissions",loginToken:"@memori:loginToken",location:"@memori:location"},getLocalConfig=(key,defaultValue)=>{try{const value=window.localStorage.getItem(keys[key]??key);if(!value)return defaultValue;try{return JSON.parse(value)}catch{return value}}catch(error){return console.error("error",error),defaultValue}},setLocalConfig=(key,value)=>{try{window.localStorage.setItem(keys[key]??key,value.toString())}catch(error){console.error("error",error)}},removeLocalConfig=key=>{try{window.localStorage.removeItem(keys[key]??key)}catch(error){console.error("error",error)}}}}]);