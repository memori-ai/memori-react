"use strict";(self.webpackChunk_memori_ai_memori_react=self.webpackChunk_memori_ai_memori_react||[]).push([[4753],{"./src/components/Avatar/AvatarView/index.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Z:()=>ContainerAvatarView});var react=__webpack_require__("./node_modules/react/index.js"),react_three_fiber_esm=__webpack_require__("./node_modules/@react-three/fiber/dist/react-three-fiber.esm.js"),SpotLight=__webpack_require__("./node_modules/@react-three/drei/core/SpotLight.js"),Environment=__webpack_require__("./node_modules/@react-three/drei/core/Environment.js"),OrbitControls=__webpack_require__("./node_modules/@react-three/drei/core/OrbitControls.js"),utils=__webpack_require__("./src/helpers/utils.ts"),lil_gui_esm=__webpack_require__("./node_modules/lil-gui/dist/lil-gui.esm.js");const components_controls=({onBaseActionChange,baseActions,modifyTimeScale,onMorphTargetInfluencesChange,onMorphTargetDictionaryChange,morphTargetDictionary,timeScale})=>{const guiRef=(0,react.useRef)(null),panelSettingsRef=(0,react.useRef)({"modify time scale":timeScale}),crossFadeControlsRef=(0,react.useRef)([]);return(0,react.useEffect)((()=>{const gui=new lil_gui_esm.ZP({width:310});guiRef.current=gui;const folder1=gui.addFolder("Base Actions"),folder2=gui.addFolder("Additive Action Weights"),folder3=gui.addFolder("General Speed");return["None",...Object.keys(baseActions)].forEach((name=>{baseActions[name];panelSettingsRef.current[name]=()=>{onBaseActionChange(name)};const control=folder1.add(panelSettingsRef.current,name);crossFadeControlsRef.current.push(control)})),Object.entries(morphTargetDictionary).forEach((([name,settings])=>{panelSettingsRef.current[name]=settings/100,folder2.add(panelSettingsRef.current,name,-1,1,.01).listen().onChange((weight=>{onMorphTargetInfluencesChange({[name]:weight})}))})),folder3.add(panelSettingsRef.current,"modify time scale",0,1.5,.01).onChange((value=>{modifyTimeScale(value)})),folder1.open(),folder2.open(),folder3.open(),()=>{gui.destroy()}}),[onBaseActionChange,onMorphTargetInfluencesChange,onMorphTargetDictionaryChange,modifyTimeScale,baseActions,morphTargetDictionary,timeScale]),null};try{controls.displayName="controls",controls.__docgenInfo={description:"",displayName:"controls",props:{baseActions:{defaultValue:null,description:"",name:"baseActions",required:!0,type:{name:"Record<string, BaseAction>"}},onBaseActionChange:{defaultValue:null,description:"",name:"onBaseActionChange",required:!0,type:{name:"(action: string) => void"}},currentBaseAction:{defaultValue:null,description:"",name:"currentBaseAction",required:!0,type:{name:"{ action: string; weight: number; }"}},onMorphTargetInfluencesChange:{defaultValue:null,description:"",name:"onMorphTargetInfluencesChange",required:!0,type:{name:"(influences: { [key: string]: number; }) => void"}},onMorphTargetDictionaryChange:{defaultValue:null,description:"",name:"onMorphTargetDictionaryChange",required:!0,type:{name:"(dictionary: { [key: string]: number; }) => void"}},morphTargetDictionary:{defaultValue:null,description:"",name:"morphTargetDictionary",required:!0,type:{name:"{ [key: string]: number; }"}},modifyTimeScale:{defaultValue:null,description:"",name:"modifyTimeScale",required:!0,type:{name:"(value: number) => void"}},timeScale:{defaultValue:null,description:"",name:"timeScale",required:!0,type:{name:"number"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/Avatar/AvatarView/AvatarComponent/components/controls.tsx#controls"]={docgenInfo:controls.__docgenInfo,name:"controls",path:"src/components/Avatar/AvatarView/AvatarComponent/components/controls.tsx#controls"})}catch(__react_docgen_typescript_loader_error){}var three_module=__webpack_require__("./node_modules/three/build/three.module.js"),useGLTF=__webpack_require__("./node_modules/@react-three/drei/core/useGLTF.js"),useAnimations=__webpack_require__("./node_modules/@react-three/drei/core/useAnimations.js");let AnimationState=function(AnimationState){return AnimationState.LOADING="LOADING",AnimationState.EMOTION="EMOTION",AnimationState.IDLE="IDLE",AnimationState}({});const AVATAR_POSITION=new three_module.Vector3(0,-1,0),AVATAR_ROTATION=new three_module.Euler(.175,0,0),AVATAR_POSITION_ZOOMED=new three_module.Vector3(0,-1.45,0),ANIMATION_URLS={MALE:"https://assets.memori.ai/api/v2/asset/2c5e88a4-cf62-408b-9ef0-518b099dfcb2.glb",FEMALE:"https://assets.memori.ai/api/v2/asset/2adc934b-24b2-45bd-94ad-ffec58d3cb32.glb"},BLINK_CONFIG_minInterval=1e3,BLINK_CONFIG_maxInterval=5e3,BLINK_CONFIG_blinkDuration=150,DEFAULT_CONFIG={fadeInDuration:.8,fadeOutDuration:.8,idleCount:5,timeScale:1};class AnimationController{currentState=AnimationState.LOADING;currentAction=null;lastIdleIndex=-1;isTransitioning=!1;currentIdleLoopCount=0;MAX_IDLE_LOOPS=5;lastAnimationTime=0;isChatAlreadyStarted=!1;constructor(mixer,actions,config=DEFAULT_CONFIG){this.mixer=mixer,this.actions=actions,this.config=config}checkForLoop(){if(!this.currentAction||this.currentState!==AnimationState.IDLE)return;this.currentAction.getClip();const currentTime=this.currentAction.time;currentTime<this.lastAnimationTime&&(this.currentIdleLoopCount++,this.currentIdleLoopCount>=this.MAX_IDLE_LOOPS&&this.forceIdleChange()),this.lastAnimationTime=currentTime}forceIdleChange(){this.currentIdleLoopCount=0,this.lastAnimationTime=0,this.transitionTo(AnimationState.IDLE)}getNextIdleAnimation(){let nextIndex;do{nextIndex=Math.floor(Math.random()*this.config.idleCount)+1}while(nextIndex===this.lastIdleIndex);this.isChatAlreadyStarted&&3===nextIndex&&(nextIndex=4!==this.lastIdleIndex?4:2),this.lastIdleIndex=nextIndex;const idleAction=this.actions[`Idle${nextIndex}`];if(!idleAction)throw new Error(`Idle animation ${nextIndex} not found`);return idleAction}transitionTo(state,emotionName){if(!this.isTransitioning){this.isTransitioning=!0;try{let nextAction=null;switch(state){case AnimationState.LOADING:nextAction=this.actions[emotionName||"Loading1"],this.currentIdleLoopCount=0,this.lastAnimationTime=0;break;case AnimationState.EMOTION:nextAction=this.actions[emotionName||"Timore1"],this.currentIdleLoopCount=0,this.lastAnimationTime=0;break;case AnimationState.IDLE:nextAction=this.getNextIdleAnimation(),this.currentState!==AnimationState.IDLE&&(this.currentIdleLoopCount=0,this.lastAnimationTime=0)}if(!nextAction)throw new Error(`No animation found for state: ${state}`);this.currentAction&&this.currentAction.fadeOut(this.config.fadeOutDuration),nextAction.reset().fadeIn(this.config.fadeInDuration).play(),nextAction.timeScale=this.config.timeScale,state!==AnimationState.IDLE?(nextAction.setLoop(three_module.LoopOnce,1),nextAction.clampWhenFinished=!0):nextAction.setLoop(1/0,1/0),this.currentAction=nextAction,this.currentState=state}catch(error){console.error("[AnimationController] Error during animation transition:",error),state!==AnimationState.IDLE&&this.transitionTo(AnimationState.IDLE)}finally{this.isTransitioning=!1}}}update(delta){this.currentAction&&(this.checkForLoop(),this.currentState!==AnimationState.IDLE&&this.currentAction.time>=.9*this.currentAction.getClip().duration&&this.transitionTo(AnimationState.IDLE),this.mixer.update(delta))}getCurrentState(){return this.currentState}getLoopCount(){return this.currentIdleLoopCount}setTimeScale(timeScale){this.config.timeScale=timeScale,this.currentAction&&(this.currentAction.timeScale=timeScale)}updateIsChatAlreadyStarted(isChatAlreadyStarted){this.isChatAlreadyStarted=isChatAlreadyStarted}getDebugInfo(){return{currentState:this.currentState,currentIdleIndex:this.lastIdleIndex,loopCount:this.currentIdleLoopCount,currentTime:this.currentAction?.time||0,lastTime:this.lastAnimationTime,isTransitioning:this.isTransitioning,isChatAlreadyStarted:this.isChatAlreadyStarted}}}class MorphTargetController{currentEmotionValues={};previousEmotionKeys=new Set;constructor(headMesh){this.headMesh=headMesh}updateMorphTargets(currentTime,emotionMorphTargets,currentViseme,eyeBlink,blinkState){if(!this.headMesh.morphTargetDictionary||!this.headMesh.morphTargetInfluences)return;const blinkValue=this.calculateBlinkValue(currentTime,blinkState,eyeBlink),currentEmotionKeys=new Set(Object.keys(emotionMorphTargets));Object.entries(this.headMesh.morphTargetDictionary).forEach((([key,index])=>{if("number"!=typeof index)return;let targetValue=0;if(currentEmotionKeys.has(key)){const targetEmotionValue=emotionMorphTargets[key],currentEmotionValue=this.currentEmotionValues[key]||0,newEmotionValue=three_module.MathUtils.lerp(currentEmotionValue,2.5*targetEmotionValue,.3);this.currentEmotionValues[key]=newEmotionValue,targetValue+=newEmotionValue}currentViseme&&key===currentViseme.name&&(targetValue+=currentViseme.weight),"eyesClosed"===key&&eyeBlink&&(targetValue+=blinkValue),targetValue=three_module.MathUtils.clamp(targetValue,0,1),this.headMesh.morphTargetInfluences&&(this.headMesh.morphTargetInfluences[index]=three_module.MathUtils.lerp(this.headMesh.morphTargetInfluences[index]||0,targetValue,.5))})),this.previousEmotionKeys=currentEmotionKeys}calculateBlinkValue(currentTime,blinkState,eyeBlink){if(!eyeBlink)return 0;let blinkValue=0;if(currentTime>=blinkState.nextBlinkTime&&!blinkState.isBlinking&&(blinkState.isBlinking=!0,blinkState.blinkStartTime=currentTime,blinkState.lastBlinkTime=currentTime,blinkState.nextBlinkTime=currentTime+Math.random()*(BLINK_CONFIG_maxInterval-BLINK_CONFIG_minInterval)+BLINK_CONFIG_minInterval),blinkState.isBlinking){const blinkProgress=(currentTime-blinkState.blinkStartTime)/BLINK_CONFIG_blinkDuration;blinkProgress<=.5?blinkValue=2*blinkProgress:blinkProgress<=1?blinkValue=2-2*blinkProgress:(blinkState.isBlinking=!1,blinkValue=0)}return blinkValue}}var jsx_runtime=__webpack_require__("./node_modules/react/jsx-runtime.js");function FullbodyAvatar({url,sex,currentBaseAction,timeScale,isZoomed,eyeBlink,updateCurrentViseme,setMorphTargetDictionary,setMorphTargetInfluences,emotionMorphTargets}){const{scene}=(0,useGLTF.L)(url),{animations}=(0,useGLTF.L)(ANIMATION_URLS[sex]),{actions}=(0,useAnimations.v)(animations,scene),animationControllerRef=(0,react.useRef)(),morphTargetControllerRef=(0,react.useRef)(),blinkStateRef=(0,react.useRef)({isBlinking:!1,lastBlinkTime:0,nextBlinkTime:0,blinkStartTime:0}),headMesh=(0,react.useMemo)((()=>{let foundMesh;return scene.traverse((object=>{object instanceof three_module.SkinnedMesh&&("GBNL__Head"===object.name||"Wolf3D_Avatar"===object.name)&&(foundMesh=object)})),foundMesh}),[scene]);return(0,react.useEffect)((()=>{if(!actions||!headMesh)return;const mixer=new three_module.AnimationMixer(scene);if(animationControllerRef.current=new AnimationController(mixer,actions,{...DEFAULT_CONFIG}),morphTargetControllerRef.current=new MorphTargetController(headMesh),headMesh.morphTargetDictionary&&headMesh.morphTargetInfluences){setMorphTargetDictionary(headMesh.morphTargetDictionary);const initialInfluences=Object.keys(headMesh.morphTargetDictionary).reduce(((acc,key)=>({...acc,[key]:0})),{});setMorphTargetInfluences(initialInfluences)}}),[actions,headMesh,scene,setMorphTargetDictionary,setMorphTargetInfluences,timeScale]),(0,react.useEffect)((()=>{animationControllerRef.current&&(currentBaseAction.action.startsWith("Loading")?animationControllerRef.current.transitionTo(AnimationState.LOADING,currentBaseAction.action):currentBaseAction.action.startsWith("Idle")?animationControllerRef.current.transitionTo(AnimationState.IDLE):(animationControllerRef.current.updateIsChatAlreadyStarted(!0),animationControllerRef.current.transitionTo(AnimationState.EMOTION,currentBaseAction.action)))}),[currentBaseAction]),(0,react.useEffect)((()=>{animationControllerRef.current?.setTimeScale(timeScale)}),[timeScale]),(0,react_three_fiber_esm.xQ)((state=>{const currentTime=1e3*state.clock.elapsedTime;if(animationControllerRef.current?.update(state.clock.getDelta()),morphTargetControllerRef.current){const currentViseme=updateCurrentViseme(currentTime/1e3);morphTargetControllerRef.current.updateMorphTargets(currentTime,emotionMorphTargets,currentViseme,eyeBlink||!1,blinkStateRef.current)}})),(0,jsx_runtime.jsx)("group",{position:isZoomed?AVATAR_POSITION_ZOOMED:AVATAR_POSITION,rotation:AVATAR_ROTATION,children:(0,jsx_runtime.jsx)("primitive",{object:scene})})}FullbodyAvatar.displayName="FullbodyAvatar";try{fullbodyAvatar.displayName="fullbodyAvatar",fullbodyAvatar.__docgenInfo={description:"",displayName:"fullbodyAvatar",props:{url:{defaultValue:null,description:"",name:"url",required:!0,type:{name:"string"}},sex:{defaultValue:null,description:"",name:"sex",required:!0,type:{name:"enum",value:[{value:'"MALE"'},{value:'"FEMALE"'}]}},onLoaded:{defaultValue:null,description:"",name:"onLoaded",required:!1,type:{name:"(() => void)"}},currentBaseAction:{defaultValue:null,description:"",name:"currentBaseAction",required:!0,type:{name:"{ action: string; weight: number; }"}},timeScale:{defaultValue:null,description:"",name:"timeScale",required:!0,type:{name:"number"}},isZoomed:{defaultValue:null,description:"",name:"isZoomed",required:!1,type:{name:"boolean"}},eyeBlink:{defaultValue:null,description:"",name:"eyeBlink",required:!1,type:{name:"boolean"}},stopProcessing:{defaultValue:null,description:"",name:"stopProcessing",required:!0,type:{name:"() => void"}},resetVisemeQueue:{defaultValue:null,description:"",name:"resetVisemeQueue",required:!0,type:{name:"() => void"}},updateCurrentViseme:{defaultValue:null,description:"",name:"updateCurrentViseme",required:!0,type:{name:"(currentTime: number) => { name: string; weight: number; } | null"}},smoothMorphTarget:{defaultValue:null,description:"",name:"smoothMorphTarget",required:!1,type:{name:"boolean"}},morphTargetSmoothing:{defaultValue:null,description:"",name:"morphTargetSmoothing",required:!1,type:{name:"number"}},morphTargetInfluences:{defaultValue:null,description:"",name:"morphTargetInfluences",required:!0,type:{name:"Record<string, number>"}},setMorphTargetDictionary:{defaultValue:null,description:"",name:"setMorphTargetDictionary",required:!0,type:{name:"(morphTargetDictionary: Record<string, number>) => void"}},setMorphTargetInfluences:{defaultValue:null,description:"",name:"setMorphTargetInfluences",required:!0,type:{name:"(morphTargetInfluences: Record<string, number>) => void"}},emotionMorphTargets:{defaultValue:null,description:"",name:"emotionMorphTargets",required:!0,type:{name:"Record<string, number>"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/Avatar/AvatarView/AvatarComponent/components/FullbodyAvatar/fullbodyAvatar.tsx#fullbodyAvatar"]={docgenInfo:fullbodyAvatar.__docgenInfo,name:"fullbodyAvatar",path:"src/components/Avatar/AvatarView/AvatarComponent/components/FullbodyAvatar/fullbodyAvatar.tsx#fullbodyAvatar"})}catch(__react_docgen_typescript_loader_error){}const halfbodyAvatar_AVATAR_POSITION=new three_module.Vector3(0,-.6,0),halfbodyAvatar_BLINK_CONFIG_minInterval=1e3,halfbodyAvatar_BLINK_CONFIG_maxInterval=5e3,halfbodyAvatar_BLINK_CONFIG_blinkDuration=150;function HalfBodyAvatar({url,setMorphTargetInfluences,setMorphTargetDictionary,eyeBlink,onLoaded,morphTargetSmoothing=.5,updateCurrentViseme}){const{scene}=(0,useGLTF.L)(url),{nodes,materials}=(0,react_three_fiber_esm.n4)(scene),mixer=(0,react.useRef)(new three_module.AnimationMixer(scene)),lastBlinkTime=((0,react.useRef)(null),(0,react.useRef)(0)),nextBlinkTime=(0,react.useRef)(0),isBlinking=(0,react.useRef)(!1),blinkStartTime=(0,react.useRef)(0),headMeshRef=(0,react.useRef)();return(0,react.useEffect)((()=>((0,utils.lc)(materials),scene.traverse((object=>{if(object instanceof three_module.SkinnedMesh&&("GBNL__Head"===object.name||"Wolf3D_Avatar"===object.name)&&(headMeshRef.current=object,object.morphTargetDictionary&&object.morphTargetInfluences)){setMorphTargetDictionary(object.morphTargetDictionary);const initialInfluences=Object.keys(object.morphTargetDictionary).reduce(((acc,key)=>({...acc,[key]:0})),{});setMorphTargetInfluences(initialInfluences)}})),onLoaded?.(),()=>{Object.values(materials).forEach((material=>material.dispose())),Object.values(nodes).filter(utils.Av).forEach((mesh=>mesh.geometry.dispose()))})),[materials,nodes,url,onLoaded,scene]),(0,react_three_fiber_esm.xQ)((state=>{if(headMeshRef.current&&headMeshRef.current.morphTargetDictionary&&headMeshRef.current.morphTargetInfluences){const currentTime=1e3*state.clock.getElapsedTime();let blinkValue=0;if(eyeBlink&&(currentTime>=nextBlinkTime.current&&!isBlinking.current&&(isBlinking.current=!0,blinkStartTime.current=currentTime,lastBlinkTime.current=currentTime,nextBlinkTime.current=currentTime+Math.random()*(halfbodyAvatar_BLINK_CONFIG_maxInterval-halfbodyAvatar_BLINK_CONFIG_minInterval)+halfbodyAvatar_BLINK_CONFIG_minInterval),isBlinking.current)){const blinkProgress=(currentTime-blinkStartTime.current)/halfbodyAvatar_BLINK_CONFIG_blinkDuration;blinkProgress<=.5?blinkValue=2*blinkProgress:blinkProgress<=1?blinkValue=2-2*blinkProgress:(isBlinking.current=!1,blinkValue=0)}const currentViseme=updateCurrentViseme(currentTime/1e3);Object.entries(headMeshRef.current.morphTargetDictionary).forEach((([key,index])=>{if("number"==typeof index){let targetValue=0;currentViseme&&key===currentViseme.name&&(targetValue+=1.3*currentViseme.weight),"eyesClosed"===key&&eyeBlink&&(targetValue+=blinkValue),targetValue=three_module.MathUtils.clamp(targetValue,0,1),headMeshRef.current&&headMeshRef.current.morphTargetInfluences&&(headMeshRef.current.morphTargetInfluences[index]=three_module.MathUtils.lerp(headMeshRef.current.morphTargetInfluences[index],targetValue,morphTargetSmoothing))}})),mixer.current.update(.01)}})),(0,jsx_runtime.jsx)("group",{position:halfbodyAvatar_AVATAR_POSITION,children:(0,jsx_runtime.jsx)("primitive",{object:scene})})}HalfBodyAvatar.displayName="HalfBodyAvatar";try{halfbodyAvatar.displayName="halfbodyAvatar",halfbodyAvatar.__docgenInfo={description:"",displayName:"halfbodyAvatar",props:{url:{defaultValue:null,description:"",name:"url",required:!0,type:{name:"string"}},setMorphTargetInfluences:{defaultValue:null,description:"",name:"setMorphTargetInfluences",required:!0,type:{name:"(morphTargetInfluences: any) => void"}},headMovement:{defaultValue:null,description:"",name:"headMovement",required:!1,type:{name:"boolean"}},speaking:{defaultValue:null,description:"",name:"speaking",required:!1,type:{name:"boolean"}},onLoaded:{defaultValue:null,description:"",name:"onLoaded",required:!1,type:{name:"(() => void)"}},setMorphTargetDictionary:{defaultValue:null,description:"",name:"setMorphTargetDictionary",required:!0,type:{name:"(morphTargetDictionary: any) => void"}},eyeBlink:{defaultValue:null,description:"",name:"eyeBlink",required:!1,type:{name:"boolean"}},morphTargetInfluences:{defaultValue:null,description:"",name:"morphTargetInfluences",required:!0,type:{name:"any"}},updateCurrentViseme:{defaultValue:null,description:"",name:"updateCurrentViseme",required:!0,type:{name:"(currentTime: number) => any"}},morphTargetSmoothing:{defaultValue:{value:"0.5"},description:"",name:"morphTargetSmoothing",required:!1,type:{name:"number"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/Avatar/AvatarView/AvatarComponent/components/halfbodyAvatar.tsx#halfbodyAvatar"]={docgenInfo:halfbodyAvatar.__docgenInfo,name:"halfbodyAvatar",path:"src/components/Avatar/AvatarView/AvatarComponent/components/halfbodyAvatar.tsx#halfbodyAvatar"})}catch(__react_docgen_typescript_loader_error){}const baseActions={Gioia1:{weight:0},Gioia2:{weight:0},Gioia3:{weight:0},Idle1:{weight:1},Idle2:{weight:0},Idle3:{weight:0},Idle4:{weight:0},Idle5:{weight:0},Rabbia1:{weight:0},Rabbia2:{weight:0},Rabbia3:{weight:0},Sorpresa1:{weight:0},Sorpresa2:{weight:0},Sorpresa3:{weight:0},Timore1:{weight:0},Timore2:{weight:0},Timore3:{weight:0},Tristezza1:{weight:0},Tristezza2:{weight:0},Tristezza3:{weight:0},Loading1:{weight:0},Loading2:{weight:0},Loading3:{weight:0}},avatarComponent_AvatarView=({stopProcessing,chatEmission,showControls,animation,url,sex,eyeBlink,headMovement,speaking,halfBody,loading,isZoomed,updateCurrentViseme,resetVisemeQueue})=>{const[currentBaseAction,setCurrentBaseAction]=(0,react.useState)({action:animation||"Idle1",weight:1}),[morphTargetInfluences,setMorphTargetInfluences]=(0,react.useState)({}),[morphTargetDictionary,setMorphTargetDictionary]=(0,react.useState)({}),[emotionMorphTargets,setEmotionMorphTargets]=(0,react.useState)({}),[timeScale,setTimeScale]=(0,react.useState)(.8),setEmotionMorphTargetInfluences=(0,react.useCallback)((action=>{if("Loading1"===action||"Loading2"===action||"Loading3"===action)return;const emotionMap={Gioia:{Gioria:1},Rabbia:{Rabbia:1},Sorpresa:{Sorpresa:1},Tristezza:{Tristezza:1},Timore:{Timore:1}},defaultEmotions=Object.keys(emotionMap).reduce(((acc,key)=>(acc[key]=0,acc)),{}),emotion=Object.keys(emotionMap).find((key=>action.startsWith(key)))||"default",emotionValues="default"===emotion?defaultEmotions:emotionMap[emotion];setEmotionMorphTargets((_=>({...defaultEmotions,...emotionValues})))}),[]),onBaseActionChange=(0,react.useCallback)((action=>{setEmotionMorphTargetInfluences(action),setCurrentBaseAction({action,weight:1})}),[]),onMorphTargetInfluencesChange=(0,react.useCallback)((influences=>{setMorphTargetInfluences((prevInfluences=>({...prevInfluences,...influences})))}),[]),onMorphTargetDictionaryChange=(0,react.useCallback)((dictionary=>{setMorphTargetDictionary(dictionary)}),[]),modifyTimeScale=(0,react.useCallback)((value=>{setTimeScale(value)}),[]);return(0,react.useEffect)((()=>{const hasOutputTag=chatEmission?.includes('<output class="memori-emotion">'),outputContent=hasOutputTag?chatEmission?.split('<output class="memori-emotion">')[1]?.split("</output>")[0]?.trim():null;if(outputContent){const randomNumber=Math.floor(3*Math.random())+1;onBaseActionChange(`${outputContent}${randomNumber}`)}else{const randomNumber=Math.floor(5*Math.random())+1;onBaseActionChange(`Idle${3===randomNumber?4:randomNumber}`)}}),[chatEmission]),(0,react.useEffect)((()=>{if(loading){const randomNumber=Math.floor(3*Math.random())+1;onBaseActionChange(`Loading${randomNumber}`)}}),[loading]),(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[showControls&&(0,jsx_runtime.jsx)(components_controls,{timeScale,morphTargetDictionary,onBaseActionChange,onMorphTargetInfluencesChange,onMorphTargetDictionaryChange,baseActions,currentBaseAction,modifyTimeScale}),halfBody?(0,jsx_runtime.jsx)(HalfBodyAvatar,{url,headMovement,speaking,eyeBlink,morphTargetInfluences,setMorphTargetInfluences,setMorphTargetDictionary,updateCurrentViseme}):(0,jsx_runtime.jsx)(FullbodyAvatar,{url,sex,resetVisemeQueue,eyeBlink,currentBaseAction,timeScale,morphTargetInfluences,isZoomed,updateCurrentViseme,stopProcessing,setMorphTargetDictionary,setMorphTargetInfluences,emotionMorphTargets})]})};try{avatarComponent_AvatarView.displayName="AvatarView",avatarComponent_AvatarView.__docgenInfo={description:"",displayName:"AvatarView",props:{showControls:{defaultValue:null,description:"",name:"showControls",required:!0,type:{name:"boolean"}},animation:{defaultValue:null,description:"",name:"animation",required:!1,type:{name:"string"}},loading:{defaultValue:null,description:"",name:"loading",required:!0,type:{name:"boolean"}},url:{defaultValue:null,description:"",name:"url",required:!0,type:{name:"string"}},sex:{defaultValue:null,description:"",name:"sex",required:!0,type:{name:"enum",value:[{value:'"MALE"'},{value:'"FEMALE"'}]}},eyeBlink:{defaultValue:null,description:"",name:"eyeBlink",required:!0,type:{name:"boolean"}},headMovement:{defaultValue:null,description:"",name:"headMovement",required:!0,type:{name:"boolean"}},speaking:{defaultValue:null,description:"",name:"speaking",required:!0,type:{name:"boolean"}},isZoomed:{defaultValue:null,description:"",name:"isZoomed",required:!0,type:{name:"boolean"}},chatEmission:{defaultValue:null,description:"",name:"chatEmission",required:!0,type:{name:"any"}},stopProcessing:{defaultValue:null,description:"",name:"stopProcessing",required:!0,type:{name:"() => void"}},resetVisemeQueue:{defaultValue:null,description:"",name:"resetVisemeQueue",required:!0,type:{name:"() => void"}},updateCurrentViseme:{defaultValue:null,description:"",name:"updateCurrentViseme",required:!0,type:{name:"(currentTime: number) => { name: string; weight: number; } | null"}},halfBody:{defaultValue:null,description:"",name:"halfBody",required:!0,type:{name:"boolean"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/Avatar/AvatarView/AvatarComponent/avatarComponent.tsx#AvatarView"]={docgenInfo:avatarComponent_AvatarView.__docgenInfo,name:"AvatarView",path:"src/components/Avatar/AvatarView/AvatarComponent/avatarComponent.tsx#AvatarView"})}catch(__react_docgen_typescript_loader_error){}var useProgress=__webpack_require__("./node_modules/@react-three/drei/core/useProgress.js"),Html=__webpack_require__("./node_modules/@react-three/drei/web/Html.js"),Spin=__webpack_require__("./src/components/ui/Spin.tsx");const Loader=({fallbackImg})=>{const{progress}=(0,useProgress.S)();return(0,jsx_runtime.jsx)(Html.V,{center:!0,className:"avatar-loader",children:(0,jsx_runtime.jsx)(Spin.Z,{spinning:!0,children:fallbackImg?(0,jsx_runtime.jsxs)("figure",{children:[(0,jsx_runtime.jsx)("img",{src:fallbackImg,alt:`${Math.round(progress)}% loaded`,title:`${Math.round(progress)}% loaded`}),(0,jsx_runtime.jsx)("figcaption",{children:`${Math.round(progress)}%`})]}):(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[Math.round(progress)," % loaded"]})})})};Loader.displayName="Loader";const components_loader=Loader;try{loader.displayName="loader",loader.__docgenInfo={description:"",displayName:"loader",props:{fallbackImg:{defaultValue:null,description:"",name:"fallbackImg",required:!1,type:{name:"string"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/Avatar/AvatarView/AvatarComponent/components/loader.tsx#loader"]={docgenInfo:loader.__docgenInfo,name:"loader",path:"src/components/Avatar/AvatarView/AvatarComponent/components/loader.tsx#loader"})}catch(__react_docgen_typescript_loader_error){}const defaultStyles={halfBody:{width:"100%",height:"100%",minHeight:"500px",backgroundColor:"white",borderRadius:"100%"},fullBody:{width:"500px",height:"500px",backgroundColor:"white"}},getCameraSettings=(halfBody,isZoomed)=>halfBody?{fov:40,position:[0,0,.6]}:!halfBody&&isZoomed?{fov:44,position:[0,0,1.25]}:{fov:40,position:[0,175e-7,3]},getLightingComponent=()=>(0,utils.Dt)()||(0,utils.Tt)()?(0,jsx_runtime.jsx)(SpotLight.P,{distance:100,position:[-.3,.2,1.25],angle:Math.PI/2,attenuation:5,anglePower:5}):(0,jsx_runtime.jsx)(Environment.qA,{files:"https://raw.githack.com/pmndrs/drei-assets/456060a26bbeb8fdf79326f224b6d99b8bcce736/hdri/venice_sunset_1k.hdr"});function ContainerAvatarView({url,sex,style,rotateAvatar,eyeBlink,headMovement,speaking,fallback,fallbackImg,halfBody=!0,loading,animation,showControls=!1,isZoomed,chatEmission,stopProcessing,resetVisemeQueue,updateCurrentViseme}){return(0,jsx_runtime.jsx)(react_three_fiber_esm.Xz,{style:style||(halfBody?defaultStyles.halfBody:defaultStyles.fullBody),camera:getCameraSettings(halfBody,isZoomed),children:(0,jsx_runtime.jsxs)(react.Suspense,{fallback:fallback||(0,jsx_runtime.jsx)(components_loader,{fallbackImg}),children:[getLightingComponent(),rotateAvatar&&(0,jsx_runtime.jsx)(OrbitControls.z,{enablePan:!1,enableZoom:!1}),(0,jsx_runtime.jsx)(avatarComponent_AvatarView,{url,sex,showControls,loading:loading||!1,animation,isZoomed:isZoomed||!1,eyeBlink:eyeBlink||!1,headMovement:headMovement||!1,speaking:speaking||!1,halfBody:halfBody||!1,chatEmission,updateCurrentViseme,stopProcessing,resetVisemeQueue})]})})}ContainerAvatarView.displayName="ContainerAvatarView";try{AvatarView.displayName="AvatarView",AvatarView.__docgenInfo={description:"",displayName:"AvatarView",props:{url:{defaultValue:null,description:"",name:"url",required:!0,type:{name:"string"}},sex:{defaultValue:null,description:"",name:"sex",required:!0,type:{name:"enum",value:[{value:'"MALE"'},{value:'"FEMALE"'}]}},fallbackImg:{defaultValue:null,description:"",name:"fallbackImg",required:!1,type:{name:"string"}},eyeBlink:{defaultValue:null,description:"",name:"eyeBlink",required:!1,type:{name:"boolean"}},headMovement:{defaultValue:null,description:"",name:"headMovement",required:!1,type:{name:"boolean"}},rotateAvatar:{defaultValue:null,description:"",name:"rotateAvatar",required:!1,type:{name:"boolean"}},speaking:{defaultValue:null,description:"",name:"speaking",required:!1,type:{name:"boolean"}},style:{defaultValue:null,description:"",name:"style",required:!1,type:{name:"CSSProperties"}},fallback:{defaultValue:null,description:"",name:"fallback",required:!1,type:{name:"ReactNode"}},halfBody:{defaultValue:{value:"true"},description:"",name:"halfBody",required:!1,type:{name:"boolean"}},loading:{defaultValue:null,description:"",name:"loading",required:!1,type:{name:"boolean"}},animation:{defaultValue:null,description:"",name:"animation",required:!1,type:{name:"string"}},showControls:{defaultValue:{value:"false"},description:"",name:"showControls",required:!1,type:{name:"boolean"}},isZoomed:{defaultValue:null,description:"",name:"isZoomed",required:!1,type:{name:"boolean"}},chatEmission:{defaultValue:null,description:"",name:"chatEmission",required:!1,type:{name:"any"}},setMeshRef:{defaultValue:null,description:"",name:"setMeshRef",required:!1,type:{name:"any"}},stopProcessing:{defaultValue:null,description:"",name:"stopProcessing",required:!0,type:{name:"() => void"}},resetVisemeQueue:{defaultValue:null,description:"",name:"resetVisemeQueue",required:!0,type:{name:"() => void"}},updateCurrentViseme:{defaultValue:null,description:"",name:"updateCurrentViseme",required:!0,type:{name:"(currentTime: number) => { name: string; weight: number; } | null"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/Avatar/AvatarView/index.tsx#AvatarView"]={docgenInfo:AvatarView.__docgenInfo,name:"AvatarView",path:"src/components/Avatar/AvatarView/index.tsx#AvatarView"})}catch(__react_docgen_typescript_loader_error){}},"./src/context/visemeContext.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{LG:()=>useViseme,jc:()=>VisemeProvider});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/react/index.js"),react_jsx_runtime__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/react/jsx-runtime.js");const VisemeContext=(0,react__WEBPACK_IMPORTED_MODULE_0__.createContext)(void 0),VISEME_MAP={0:"viseme_sil",1:"viseme_PP",2:"viseme_FF",3:"viseme_TH",4:"viseme_DD",5:"viseme_kk",6:"viseme_CH",7:"viseme_SS",8:"viseme_nn",9:"viseme_RR",10:"viseme_aa",11:"viseme_E",12:"viseme_I",13:"viseme_O",14:"viseme_U",15:"viseme_kk",16:"viseme_CH",17:"viseme_SS",18:"viseme_TH",19:"viseme_RR",20:"viseme_kk",21:"viseme_PP"},{DEFAULT_VISEME_DURATION,VISEME_OVERLAP,SMOOTHING_FACTOR,LOG_INTERVAL,PRELOAD,WEIGHT_MULTIPLIER}={DEFAULT_VISEME_DURATION:.1,VISEME_OVERLAP:.02,SMOOTHING_FACTOR:.4,LOG_INTERVAL:60,PRELOAD:.5,WEIGHT_MULTIPLIER:.8},timing_isExpired=(viseme,currentTime)=>viseme.endTime<currentTime-VISEME_OVERLAP,timing_calculateWeight=progress=>Math.sin(Math.PI*Math.min(progress,1))*WEIGHT_MULTIPLIER,timing_smoothWeight=(currentWeight,targetWeight)=>currentWeight+(targetWeight-currentWeight)*SMOOTHING_FACTOR,createLogger=type=>(event,data)=>{console.log(`%c[VisemeContext] ${event}`,{event:"color: #4CAF50; font-weight: bold;",error:"color: #f44336; font-weight: bold;",debug:"color: #2196F3; font-weight: bold;"}[type],data)},logVisemeEvent=createLogger("event"),logVisemeError=createLogger("error"),logVisemeDebug=createLogger("debug"),VisemeProvider=({children})=>{const visemeQueueRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)([]),audioContextRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(null),audioStartTimeRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(null),[isProcessing,setIsProcessing]=(0,react__WEBPACK_IMPORTED_MODULE_0__.useState)(!1),[visemeState,setVisemeState]=(0,react__WEBPACK_IMPORTED_MODULE_0__.useState)("idle"),lastVisemeRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(null),frameCountRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(0),firstVisemeTimeRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(null),setAudioContext=(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)((ctx=>{audioContextRef.current=ctx,ctx.onstatechange=()=>{switch(logVisemeEvent("Audio Context State Change",{state:ctx.state,currentTime:ctx.currentTime}),ctx.state){case"running":setVisemeState("active");break;case"suspended":setVisemeState("paused");break;case"closed":setVisemeState("finished"),stopProcessing()}}}),[]),addViseme=(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)(((visemeId,audioOffset)=>{if("finished"===visemeState)return;const visemeName=VISEME_MAP[visemeId]||"viseme_sil",startTime=audioOffset/1e7;null===firstVisemeTimeRef.current&&(firstVisemeTimeRef.current=startTime);const relativeStartTime=startTime-(firstVisemeTimeRef.current||0),newViseme={name:visemeName,weight:0,startTime:relativeStartTime,endTime:relativeStartTime+DEFAULT_VISEME_DURATION};visemeQueueRef.current.push(newViseme),"idle"===visemeState&&setVisemeState("preparing")}),[visemeState]),startProcessing=(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)((audioCtx=>{audioCtx?(audioContextRef.current=audioCtx,audioStartTimeRef.current=audioCtx.currentTime,frameCountRef.current=0,setIsProcessing(!0),setVisemeState("active"),logVisemeEvent("Started Processing",{audioTime:audioCtx.currentTime,queueLength:visemeQueueRef.current.length,state:visemeState})):logVisemeError("No audio context provided",{state:visemeState})}),[]),stopProcessing=(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)((()=>{setIsProcessing(!1),setVisemeState("finished"),audioStartTimeRef.current=null,lastVisemeRef.current=null,frameCountRef.current=0,audioContextRef.current=null,logVisemeEvent("Stopped Processing",{queueLength:visemeQueueRef.current.length,state:visemeState})}),[]),updateCurrentViseme=(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)((_=>{if(!isProcessing||!audioContextRef.current)return null;const audioTime=audioContextRef.current.currentTime-(audioStartTimeRef.current||0)+PRELOAD;visemeQueueRef.current=visemeQueueRef.current.filter((v=>!timing_isExpired(v,audioTime)));const currentViseme=visemeQueueRef.current.find((v=>v.startTime<=audioTime&&v.endTime>audioTime-VISEME_OVERLAP));if(frameCountRef.current%LOG_INTERVAL==60&&logVisemeDebug("Current Viseme",{currentViseme,audioTime,visemeQueue:visemeQueueRef.current}),currentViseme){const progress=(audioTime-currentViseme.startTime)/(currentViseme.endTime-currentViseme.startTime),targetWeight=timing_calculateWeight(progress),smoothedWeight=lastVisemeRef.current?timing_smoothWeight(lastVisemeRef.current.weight,targetWeight):targetWeight,updatedViseme={...currentViseme,weight:smoothedWeight};return lastVisemeRef.current=updatedViseme,updatedViseme}if(lastVisemeRef.current){const reducedWeight=lastVisemeRef.current.weight*(1-SMOOTHING_FACTOR);lastVisemeRef.current={...lastVisemeRef.current,weight:reducedWeight}}return lastVisemeRef.current=null,null}),[isProcessing]),resetVisemeQueue=(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)((()=>{visemeQueueRef.current=[],lastVisemeRef.current=null,audioStartTimeRef.current=null,firstVisemeTimeRef.current=null,frameCountRef.current=0,setVisemeState("idle"),logVisemeEvent("Reset Viseme Queue",{previousState:visemeState})}),[visemeState]),resetAndStartProcessing=(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)((audioCtx=>{logVisemeEvent("Reset And Start Processing",{previousState:visemeState,queueLength:visemeQueueRef.current.length}),stopProcessing(),resetVisemeQueue(),startProcessing(audioCtx)}),[stopProcessing,resetVisemeQueue,startProcessing,visemeState]),contextValue=(0,react__WEBPACK_IMPORTED_MODULE_0__.useMemo)((()=>({addViseme,updateCurrentViseme,startProcessing,stopProcessing,resetAndStartProcessing,resetVisemeQueue,isProcessing,setAudioContext})),[addViseme,updateCurrentViseme,startProcessing,stopProcessing,resetAndStartProcessing,resetVisemeQueue,isProcessing,setAudioContext]);return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_1__.jsx)(VisemeContext.Provider,{value:contextValue,children})};VisemeProvider.displayName="VisemeProvider";const useViseme=()=>{const context=(0,react__WEBPACK_IMPORTED_MODULE_0__.useContext)(VisemeContext);if(!context)throw new Error("useVisemeContext must be used within a VisemeProvider");return context};try{VisemeProvider.displayName="VisemeProvider",VisemeProvider.__docgenInfo={description:"",displayName:"VisemeProvider",props:{}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/context/visemeContext.tsx#VisemeProvider"]={docgenInfo:VisemeProvider.__docgenInfo,name:"VisemeProvider",path:"src/context/visemeContext.tsx#VisemeProvider"})}catch(__react_docgen_typescript_loader_error){}}}]);